---
title: "Summary of TMB runs"
author: "Lena Morrill"
date: "24/05/2021"
output: pdf_document
header-includes:
   - \usepackage{array}
   - \setlength{\textwidth}{6.7in}
   - \setlength{\oddsidemargin}{-0.1in}
   - \setlength{\textheight}{8.6in}
   - \setlength{\topmargin}{-0.4in}
   - \newcolumntype{L}[1]{>{\raggedright\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}
   - \newcolumntype{C}[1]{>{\centering\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}
   - \newcolumntype{R}[1]{>{\raggedleft\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache=TRUE)
```

```{r libraries, echo=FALSE, message=FALSE, cache=TRUE, results='hide'}

library(ggrepel)
library(Ternary)
library(MCMCpack)
library(dplyr)
library(gridExtra)
library(parallel)
library(TMB)
library(pheatmap)

source("../2_inference_TMB/helper_TMB.R")
source("../../../CDA_in_Cancer/code/functions/meretricious/pretty_plots/prettySignatures.R")

TMB::compile("../2_inference_TMB/mm_multinomial/fullRE_dirichletmultinomial_single_lambda.cpp", "-std=gnu++17")
dyn.load(dynlib("../2_inference_TMB/mm_multinomial/fullRE_dirichletmultinomial_single_lambda"))
TMB::compile("../2_inference_TMB/mm_multinomial/fullRE_dirichletmultinomial_single_lambda2.cpp", "-std=gnu++17")
dyn.load(dynlib("../2_inference_TMB/mm_multinomial/fullRE_dirichletmultinomial_single_lambda2"))
TMB::compile("../2_inference_TMB/mm_multinomial/diagRE_dirichletmultinomial_single_lambda.cpp", "-std=gnu++17")
dyn.load(dynlib("../2_inference_TMB/mm_multinomial/diagRE_dirichletmultinomial_single_lambda"))
TMB::compile("../2_inference_TMB/mm_multinomial/diagRE_ME_dirichletmultinomial.cpp", "-std=gnu++17")
dyn.load(dynlib("../2_inference_TMB/mm_multinomial/diagRE_ME_dirichletmultinomial"))
TMB::compile("../../current/Dirichlet_Multinomial_Dom/code/TMB_models/sparseRE_ME_dirichletmultinomial.cpp", "-std=gnu++17")
dyn.load(dynlib("../../current/Dirichlet_Multinomial_Dom/code/TMB_models/sparseRE_ME_dirichletmultinomial"))
TMB::compile("../../current/Dirichlet_Multinomial_Dom/code/TMB_models/sparseRE_ME_dirichletmultinomialsinglelambda.cpp", "-std=gnu++17")
dyn.load(dynlib("../../current/Dirichlet_Multinomial_Dom/code/TMB_models/sparseRE_ME_dirichletmultinomialsinglelambda"))
TMB::compile("../../current/Dirichlet_Multinomial_Dom/code/TMB_models/sparseRE_ME_dirichletmultinomialsinglelambda2.cpp", "-std=gnu++17")
dyn.load(dynlib("../../current/Dirichlet_Multinomial_Dom/code/TMB_models/sparseRE_ME_dirichletmultinomialsinglelambda2"))
TMB::compile("../../current/Dirichlet_Multinomial_Dom/code/TMB_models/sparseRE_ME_dirichletmultinomial_singlecov.cpp", "-std=gnu++17")
dyn.load(dynlib("../../current/Dirichlet_Multinomial_Dom/code/TMB_models/sparseRE_ME_dirichletmultinomial_singlecov"))
TMB::compile("../2_inference_TMB/mm_multinomial/fullRE_ME_halfdirichletmultinomial.cpp", "-std=gnu++17")
dyn.load(dynlib("../2_inference_TMB/mm_multinomial/fullRE_ME_halfdirichletmultinomial"))
TMB::compile("../2_inference_TMB/mm_multinomial/fullRE_ME_dirichletmultinomial.cpp", "-std=gnu++17")
dyn.load(dynlib("../2_inference_TMB/mm_multinomial/fullRE_ME_dirichletmultinomial"))
TMB::compile("../2_inference_TMB/mm_multinomial/diagRE_ME_dirichletmultinomial.cpp", "-std=gnu++17")
dyn.load(dynlib("../2_inference_TMB/mm_multinomial/diagRE_ME_dirichletmultinomial"))
TMB::compile("../2_inference_TMB/mm_multinomial/diagRE_ME_multinomial.cpp", "-std=gnu++17")
dyn.load(dynlib("../2_inference_TMB/mm_multinomial/diagRE_ME_multinomial"))
TMB::compile("../2_inference_TMB/mm_multinomial/fullRE_ME_multinomial.cpp", "-std=gnu++17")
dyn.load(dynlib("../2_inference_TMB/mm_multinomial/fullRE_ME_multinomial"))
```

```{r, read_ct, echo=FALSE}
enough_samples = read.table("~/Desktop/CT_sufficient_samples.txt", comment.char='#')[,1]
nonexogenous = read.table("../../data/cosmic/exogenous_signatures_SBS.txt", sep = "\t",
                          comment.char = "#", fill = F)
subset_sigs_sparse_cov_idx_nonexo <- read.table("../../current/subset_sigs_sparse_cov_idx_nonexo.txt", stringsAsFactors = F, fill = T)
```


```{r, read_tmb_runs, warning=FALSE, echo=FALSE, message=FALSE, error=FALSE, results='hide'}
diagRE_DMSL <- sapply(enough_samples, function(ct){
  try(readRDS(paste0("../../data/pcawg_robjects_cache/tmb_results/nlminb/diagRE_DMSL_", ct, "_signatures.RDS")))
}, simplify = F)

diagRE_DMDL <- sapply(enough_samples, function(ct){
  try(readRDS(paste0("../../data/pcawg_robjects_cache/tmb_results/optim/diagRE_DM_", ct, "_signatures.RDS")))
}, simplify = F)

fullRE_DMDL <- sapply(enough_samples, function(ct){
  try(readRDS(paste0("../../data/pcawg_robjects_cache/tmb_results/optim/fullRE_DM_", ct, "_signatures.RDS")))
}, simplify = F)

fullRE_M_nonexo <- sapply(enough_samples, function(ct){
  try(readRDS(paste0("../../data/pcawg_robjects_cache/tmb_results/nlminb/fullRE_nonexo_M_", ct, "_signatures.RDS")))
}, simplify = F)

fullRE_M <- sapply(enough_samples, function(ct){
  try(readRDS(paste0("../../data/pcawg_robjects_cache/tmb_results/optim/fullRE_M_", ct, "_signatures.RDS")))
}, simplify = F)

diagRE_M <- sapply(enough_samples, function(ct){
  try(readRDS(paste0("../../data/pcawg_robjects_cache/tmb_results/optim/diagRE_M_", ct, "_signatures.RDS")))
}, simplify = F)

sparseRE_DMSL <- sapply(enough_samples, function(ct){
  try(readRDS(paste0("../../data/pcawg_robjects_cache/tmb_results/nlminb/sparseRE_DMSL2_", ct, "_signatures.RDS")))
}, simplify = F)

fullRE_DMDL_nonexo <- sapply(enough_samples, function(ct){
  try(readRDS(paste0("../../data/pcawg_robjects_cache/tmb_results/nlminb/fulLRE_nonexo_DM_", ct, "_signatures.RDS")))
}, simplify = F)

fullRE_DMDL_sortednonexo <- sapply(enough_samples, function(ct){
  try(readRDS(paste0("../../data/pcawg_robjects_cache/tmb_results/nlminb/fulLRE_sortednonexo_DM_", ct, "_signatures.RDS")))
}, simplify = F)

fullRE_DMSL_nonexo <- sapply(enough_samples, function(ct){
  try(readRDS(paste0("../../data/pcawg_robjects_cache/tmb_results/nlminb/fullRE_nonexo_DMSL_", ct, "_signatures.RDS")))
}, simplify = F)

diagRE_DMSL_nonexo <- sapply(enough_samples, function(ct){
  try(readRDS(paste0("../../data/pcawg_robjects_cache/tmb_results/nlminb/diagRE_nonexo_DMSL_", ct, "_signatures.RDS")))
}, simplify = F)

fullRE_DMSL_SBS1 <- sapply(enough_samples, function(ct){
  try(readRDS(paste0("../../data/pcawg_robjects_cache/tmb_results/nlminb/fullRE_SBS1baseline_DMSL_", ct, "signatures.RDS")))
}, simplify = F)

fullRE_halfDM <- sapply(enough_samples, function(ct){
  try(readRDS(paste0("../../data/pcawg_robjects_cache/tmb_results/nlminb/fullRE_halfDM_", ct, "signatures.RDS")))
}, simplify = F)

fullRE_DMSL <- sapply(enough_samples, function(ct){
  try(readRDS(paste0("../../data/pcawg_robjects_cache/tmb_results/nlminb/fullRE_DMSL_", ct, "_signatures.RDS")))
}, simplify = F)

diagRE_DMSL <- sapply(enough_samples, function(ct){
  try(readRDS(paste0("../../data/pcawg_robjects_cache/tmb_results/nlminb/diagRE_DMSL_", ct, "_signatures.RDS")))
}, simplify = F)

sparseRE_DMSL_nonexo <- sapply(enough_samples, function(ct){
  try(readRDS(paste0("../../data/pcawg_robjects_cache/tmb_results/nlminb/sparseRE_nonexo_DMSL_", ct, "_signatures.RDS")))
}, simplify = F)

```

\tableofcontents

\newpage

\section{Information about models}

\subsection{Default order of categories for each model}
\begin{tabular}{llL{1in}l}
Name model & Extension & Sorted & File in which they were created\\\hline\hline
\verb|fullREDMsinglelambda| &	\verb|fullRE_DMSL_|	& Not sorted &	\verb|run_TMB_PCAWG.R|\\\hline
\verb|fullREDMsinglelambda2|	& \verb|fullRE_DMSL2_|	& Sorted	& \verb|run_TMB_PCAWG.R|\\\hline
\verb|diagREDMsinglelambda| & 	\verb|diagRE_DMSL_|	& Unknown	& \verb|run_TMB_PCAWG.R|\\\hline
\verb|fullRE_M|	& \verb|fullRE_M_| & Sorted in previous version of \verb|wrapper_run_TMB|& \verb|run_TMB_PCAWG.R|\\\hline
\verb|diagRE_DM|	& \verb|diagRE_DM_| & Sorted in previous version of \verb|wrapper_run_TMB|& \verb|run_TMB_PCAWG.R|\\\hline
\verb|fullRE_DM|	& \verb|fullRE_DM_| & Sorted in previous version of \verb|wrapper_run_TMB|& \verb|run_TMB_PCAWG.R|\\\hline
\verb|sparseRE_DMSL2|	& \verb|sparseRE_nonexo_DMSL_| & Sorted & 	\verb|find_subset_signatures.R|\\\hline
\verb|fullREDMsinglelambda| &	\verb|fullRE_nonexo_DMSL_| &	Not sorted &	\verb|find_subset_signatures.R| \\\hline
\verb|fullRE_M| &	\verb|fullRE_nonexo_M_|	& Not sorted &	\verb|find_subset_signatures.R| \\\hline
\verb|diagREDMsinglelambda|	& \verb|diagRE_nonexo_DMSL_| &	Not sorted &	\verb|find_subset_signatures.R| \\\hline
\verb|fullRE_DM| &	\verb|fulLRE_nonexo_DM_| &	Not sorted &	\verb|find_subset_signatures.R| \\\hline
\verb|diagREDMsinglelambda| &	\verb|diagRE_DMSL_| &	Not sorted &	\verb|find_subset_signatures.R|\\\hline
\end{tabular}


\section{General results of all models}
Check the results of all of the models

```{r, summary_convergence, dependson=c('read_tmb_runs'), fig.height=6, echo=FALSE}
list_models <- c( 'diagRE_M', 'fullRE_M',
                  'diagRE_DMDL','fullRE_halfDM', 'fullRE_DMDL', 
                  'diagRE_DMSL','sparseRE_DMSL', 'fullRE_DMSL', 'fullRE_DMSL_SBS1',
                  'fullRE_M_nonexo','diagRE_DMSL_nonexo','sparseRE_DMSL_nonexo', 'fullRE_DMSL_nonexo',
                  'fullRE_DMDL_nonexo', 'fullRE_DMDL_sortednonexo')

all_summaries <- lapply(lapply(list_models, get), function(i){
    give_summary_of_runs2(i, long_return = T)})
names(all_summaries) <- list_models

ggplot(melt(all_summaries), aes(x=factor(L1, levels=list_models), y=value, fill=L2))+geom_tile()+
  theme(axis.text.x=element_text(angle = 45, hjust = 1))+theme(legend.position = "bottom")

```

\newpage

\section{Analysis per cancer type}

\subsection{Bone osteosarcoma}

\subsubsection{Barplot and general statistics}
```{r BoneOsteosarc1, echo=FALSE}
ct <- "Bone-Osteosarc"
obj_Bone_Osteosarc <- load_PCAWG(ct = ct, typedata = "signatures",
                                   path_to_data = "../../data/")
give_barplot_from_obj(obj = obj_Bone_Osteosarc, legend_on = TRUE)
```

The number of samples and signatures is:
```{r BoneOsteosarc1b, echo=FALSE}
dim(obj_Bone_Osteosarc$Y)
```

The signatures are:
```{r BoneOsteosarc1c, echo=FALSE}
colnames(obj_Bone_Osteosarc$Y)
```

\subsubsection{Convergence table}

We only have converged results for the multinomial with full RE, and the DM with a single lambda (diag and full RE). It is the same for nonexogenous signatures.

```{r BoneOsteosarc2, echo=FALSE, dependson=c('summary_convergence')}
ct <- "Bone-Osteosarc"
melt(all_summaries) %>% filter(value==ct)
```

\subsubsection{Re-running of fitting}

```{r BoneOsteosarc3, echo=FALSE, message=FALSE, dependson=c('libraries'), results='hide'}
ct <- "Bone-Osteosarc"

obj <- sort_columns_TMB(load_PCAWG(ct = ct, typedata = "signatures",
                                   path_to_data = "../../data/"))
sortedM <- wrapper_run_TMB(model = "fullRE_M",
                           object = obj)
sortedM

## use params from ME M for ME DM
dmin1 <- ncol(obj$Y)-1

sortedDM <- wrapper_run_TMB(model = "fullRE_DM",
                           object = obj,
                           smart_init_vals = F, use_nlminb = T,
                           initial_params = list(
                             beta = matrix(python_like_select_name(sortedM$par.fixed, 'beta'), nrow=2),
                             u_large = matrix(sortedM$par.random, ncol=dmin1),
                             logs_sd_RE=python_like_select_name(sortedM$par.fixed, 'logs_sd_RE'),
                             cov_par_RE = python_like_select_name(sortedM$par.fixed, 'cov_par_RE'),
                             log_lambda = matrix(c(2,2))))
sortedDM

```

If we use the values of the fullRE M as initial values for the fullRE DM, we also don't get convergence:
```{r BoneOsteosarc3b, echo=FALSE, message=FALSE, dependson=c('BoneOsteosarc3')}
sortedDM$pdHess
```

\subsubsection{Potentially problematic signatures}

We notice that we have several signatures with low exposures, and many zero exposures
```{r, BoneOsteosarc1d}
colSums(obj_Bone_Osteosarc$Y == 0)/nrow(obj_Bone_Osteosarc$Y)
colSums(obj_Bone_Osteosarc$Y)/sum(obj_Bone_Osteosarc$Y)
```

E.g.

\begin{itemize}
\item SBS17b is 0 in `r round( (colSums(obj_Bone_Osteosarc$Y == 0)/nrow(obj_Bone_Osteosarc$Y))['SBS17b'], digits=3)*100`\% of cases and has an overall exposure of `r round((colSums(obj_Bone_Osteosarc$Y)/sum(obj_Bone_Osteosarc$Y))['SBS17b'], digits=3)*100`\%
\item SBS30 is 0 in `r round( (colSums(obj_Bone_Osteosarc$Y == 0)/nrow(obj_Bone_Osteosarc$Y))['SBS30'], digits=3)*100`\% of cases and overal has an exposure of only `r round((colSums(obj_Bone_Osteosarc$Y)/sum(obj_Bone_Osteosarc$Y))['SBS30'], digits=3)*100`\%
\item SBS5 is 0 in `r round( (colSums(obj_Bone_Osteosarc$Y == 0)/nrow(obj_Bone_Osteosarc$Y))['SBS5'], digits=3)*100`\% of cases and has an overall exposure of `r round((colSums(obj_Bone_Osteosarc$Y)/sum(obj_Bone_Osteosarc$Y))['SBS5'], digits=3)*100`\%
\end{itemize}

\subsubsection{Betas}

```{r, BoneOsteosarc_betas}
ct <- "Bone-Osteosarc"

grid.arrange(plot_betas(diagRE_M[[ct]])+ggtitle(paste0(ct, '\n diagRE_M')),
plot_betas(fullRE_DMSL[[ct]])+ggtitle(paste0(ct, '\n fullRE_DMSL')),
plot_betas(diagRE_DMSL[[ct]])+ggtitle(paste0(ct, '\n diagRE_DMSL')),
plot_betas(sparseRE_DMSL[[ct]])+ggtitle(paste0(ct, '\n sparseRE_DMSL')), nrow=2)

grid.arrange(
  plot_betas(fullRE_M_nonexo[[ct]])+ggtitle(paste0(ct, '\n fullRE_M_nonexo')),
  plot_betas(fullRE_DMSL_nonexo[[ct]])+ggtitle(paste0(ct, '\n fullRE_DMSL_nonexo')),
plot_betas(diagRE_DMSL_nonexo[[ct]])+ggtitle(paste0(ct, '\n diagRE_DMSL_nonexo')),
plot_betas(sparseRE_DMSL_nonexo[[ct]])+ggtitle(paste0(ct, '\n sparseRE_DMSL_nonexo')), nrow=2)
```


```{r, BoneOsteosarc_DA, echo=FALSE, message=FALSE, results='hide'}
ct <- "Bone-Osteosarc"
pval_bone_osteosarc <- wald_TMB_wrapper(diagRE_DMSL_nonexo[[ct]])
```
We use the results from the diagonal single lambda DM to test for differential abundance, giving a p-value of `r pval_bone_osteosarc`.

\subsubsection{Covariance matrices}

```{r}
ct <- "Bone-Osteosarc"
additional_sortedM <- list()
additional_sortedDM <- list()
additional_sortedM[[ct]] <- sortedM
additional_sortedDM[[ct]] <- sortedDM
```

Note that sortedDM did not convergence.

Nevertheless, both versions of fullRE M -- both of which converged and use the same baseline -- give very different covariances matrices.

```{r, BoneOsteosarc_cov, echo=FALSE, message=FALSE, fig.height=3.7, fig.width=3.7}
ct <- "Bone-Osteosarc"
# models_it_bone_osteosarc <- c('fullRE_M', 'sparseRE_DMSL', 'fullRE_M_nonexo')
models_it_bone_osteosarc <- c('fullRE_M', 'fullRE_M_nonexo', 'additional_sortedM', 'additional_sortedDM')
covmats_bone_osteosarc <- lapply(models_it_bone_osteosarc,
                                 function(i){
     fill_covariance_matrix(arg_d = length(python_like_select_name(get(i)[[ct]]$par.fixed, 'beta'))/2,
                            arg_entries_var = python_like_select_name(get(i)[[ct]]$par.fixed, 'logs_sd_RE'),
                            arg_entries_cov = python_like_select_name(get(i)[[ct]]$par.fixed, 'cov_par_RE'))
                                 })
names(covmats_bone_osteosarc) <- models_it_bone_osteosarc
## because it's fullRE_M, it's sorted
colnames(covmats_bone_osteosarc[['fullRE_M']]) <- rownames(covmats_bone_osteosarc[['fullRE_M']]) <- vector_cats_to_logR(colnames(sort_columns_TMB(obj_Bone_Osteosarc)$Y))
colnames(covmats_bone_osteosarc[['additional_sortedM']]) <- rownames(covmats_bone_osteosarc[['additional_sortedM']]) <- vector_cats_to_logR(colnames(sort_columns_TMB(obj_Bone_Osteosarc)$Y))
colnames(covmats_bone_osteosarc[['additional_sortedDM']]) <- rownames(covmats_bone_osteosarc[['additional_sortedDM']]) <- vector_cats_to_logR(colnames(sort_columns_TMB(obj_Bone_Osteosarc)$Y))
## because it's fullRE_M_nonexo, it's sorted
colnames(covmats_bone_osteosarc[['fullRE_M_nonexo']]) <- rownames(covmats_bone_osteosarc[['fullRE_M_nonexo']]) <- vector_cats_to_logR(colnames(give_subset_sigs_TMBobj(obj_Bone_Osteosarc, nonexogenous$V1)$Y))

for(i in 1:length(covmats_bone_osteosarc)){pheatmap(covmats_bone_osteosarc[[i]], cluster_rows = F, cluster_cols = F, main = models_it_bone_osteosarc[i])}
```

\subsubsection{Simulation under inferred data}

```{r, BoneOsteosarc_sim, echo=FALSE}
sim_Bone_Osteosarc <- give_sim_from_estimates(enough_samples[2], "signatures", sigs_to_remove=unique(nonexogenous$V1), bool_give_PCA = T, path_to_data= "../../data/")
sim_Bone_Osteosarc[[2]]+ggtitle('Simulation of Bone osteosarcoma samples')
```

\subsubsection{Ranked plot for coverage}

```{r, BoneOsteosarc_ranked_plot}
ct <- "Bone-Osteosarc"
integer_overdispersion_param_DMSL <- 1
obj_Bone_Osteosarc_nonexo <- give_subset_sigs_TMBobj(obj_Bone_Osteosarc, sigs_to_remove = nonexogenous$V1)
grid.arrange(give_interval_plots_2(df_rank = lapply(list(give_ranked_plot_simulation(tmb_fit_object = fullRE_M_nonexo[[ct]],
                 data_object = obj_Bone_Osteosarc_nonexo,
                 print_plot = F, nreps = 20, model = "M")), function(i){
                   lapply(i, function(j) cbind.data.frame(sorted_value=as.vector(j),
                                                          rank_number=1:length(j)) )})[[1]],
                 data_object = obj_Bone_Osteosarc_nonexo,
                 loglog = F, title = 'obj_Bone_Osteosarc (M)'),
 give_interval_plots_2(df_rank = lapply(list(give_ranked_plot_simulation(tmb_fit_object = fullRE_DMSL_nonexo[[ct]],
                 data_object = obj_Bone_Osteosarc_nonexo,
                 print_plot = F, nreps = 20, model = "DMSL", integer_overdispersion_param = integer_overdispersion_param_DMSL)), function(i){
                   lapply(i, function(j) cbind.data.frame(sorted_value=as.vector(j),
                                                          rank_number=1:length(j)) )})[[1]],
                 data_object = obj_Bone_Osteosarc_nonexo,
                 loglog = F, title = 'obj_Bone_Osteosarc (DMSL)'), ncol=2)
```

73/359=20\% of values are not included in the confidence interval of the DMSL.


\subsubsection{Signatures from mutSigExtractor}

The signatures from mutSigExtractor are a bit more chaotic:
```{r, BoneOsteosarc_mutsigextractor}
obj_Bone_Osteosarc_mutSigExtractor <- load_PCAWG(ct = ct, typedata = "signaturesmutSigExtractor",
                                   path_to_data = "../../data/")
give_barplot_from_obj(obj = obj_Bone_Osteosarc_mutSigExtractor, legend_on = FALSE)
```


\subsection{Breast-AdenoCA}
\subsubsection{Barplot and general statistics}
```{r BreastAdenoCA1, echo=FALSE}
ct <- "Breast-AdenoCA"
obj_Breast_AdenoCA <- load_PCAWG(ct = ct, typedata = "signatures",
                                   path_to_data = "../../data/")
give_barplot_from_obj(obj = obj_Breast_AdenoCA, legend_on = TRUE)
```

There are many signatures, and also many samples.


The number of samples and signatures is:
```{r BreastAdenoCA1b, echo=FALSE}
dim(obj_Breast_AdenoCA$Y)
```

The signatures are:
```{r BreastAdenoCA1c, echo=FALSE}
colnames(obj_Breast_AdenoCA$Y)
```

\subsubsection{Convergence table}

We only have converged results for the diagRE_DMSL, with diagonal or sparse covariance structure, and diagonal M.
 This is probably due to the very high number of signatures, which make it impossible to infer the whole covariance structure.

```{r BreastAdenoCA2, echo=FALSE, dependson=c('summary_convergence')}
melt(all_summaries) %>% filter(value=="Breast-AdenoCA")
```

\subsubsection{Re-running of fitting}

```{r obj_Breast_AdenoCA3, echo=FALSE, message=FALSE, dependson=c('libraries'), results='hide'}
ct <- "Breast-AdenoCA"

obj_Breast_Adeno_sorted <- sort_columns_TMB(load_PCAWG(ct = ct, typedata = "signatures",
                                   path_to_data = "../../data/"))
sortedM_Breast_Adeno <- wrapper_run_TMB(model = "diagRE_M",
                           object = obj_Breast_Adeno_sorted)
sortedM_Breast_Adeno

## use params from diagME M for diagME DM
sortedDM_Breast_Adeno <- wrapper_run_TMB(model = "diagRE_DM",
                           object = obj_Breast_Adeno_sorted,
                           smart_init_vals = F, use_nlminb = T,
                           initial_params = list(
                             beta = matrix(python_like_select_name(sortedM_Breast_Adeno$par.fixed, 'beta'), nrow=2),
                             u_large = matrix(sortedM_Breast_Adeno$par.random, ncol=ncol(obj_Breast_Adeno_sorted$Y)-1),
                             logs_sd_RE=python_like_select_name(sortedM_Breast_Adeno$par.fixed, 'logs_sd_RE'),
                             log_lambda = matrix(c(2,2))))
sortedDM_Breast_Adeno
```

If we use the values of the diagRE M as initial values for the diagRE DM, we that it has converged. This is probably due to a combination of things: we are using the optimiser nlminb (better in general than the alternative, optim) and we are starting with these - better - values, and we are sorting the columns so that the category with highest total value is the baseline.
```{r obj_Breast_AdenoCA3b, echo=FALSE, message=FALSE, dependson=c('BoneOsteosarc3')}
sortedDM_Breast_Adeno$pdHess
```


```{r}
ct <- "Breast-AdenoCA"
additional_sorteddiagM <- list()
additional_sorteddiagDM <- list()
additional_sorteddiagM[[ct]] <- sortedM_Breast_Adeno
additional_sorteddiagDM[[ct]] <- sortedDM_Breast_Adeno
```

\subsubsection{Potentially problematic signatures}

We notice that we have several signatures with low exposures, and many zero exposures
```{r, obj_Breast_AdenoCA3d}
colSums(obj_Breast_AdenoCA$Y == 0)/nrow(obj_Breast_AdenoCA$Y)
colSums(obj_Breast_AdenoCA$Y)/sum(obj_Breast_AdenoCA$Y)
```

E.g.

\begin{itemize}
\item SBS9 is 0 in `r round( (colSums(obj_Breast_AdenoCA$Y == 0)/nrow(obj_Breast_AdenoCA$Y))['SBS9'], digits=3)*100`\% of cases and has an overall exposure of `r round((colSums(obj_Breast_AdenoCA$Y)/sum(obj_Breast_AdenoCA$Y))['SBS9'], digits=3)*100`\%
\item SBS12 is 0 in `r round( (colSums(obj_Breast_AdenoCA$Y == 0)/nrow(obj_Breast_AdenoCA$Y))['SBS12'], digits=3)*100`\% of cases and has an overall exposure of `r round((colSums(obj_Breast_AdenoCA$Y)/sum(obj_Breast_AdenoCA$Y))['SBS12'], digits=3)*100`\%
\item SBS17a is 0 in `r round( (colSums(obj_Breast_AdenoCA$Y == 0)/nrow(obj_Breast_AdenoCA$Y))['SBS17a'], digits=3)*100`\% of cases and has an overall exposure of `r round((colSums(obj_Breast_AdenoCA$Y)/sum(obj_Breast_AdenoCA$Y))['SBS17a'], digits=3)*100`\%
\item SBS17b is 0 in `r round( (colSums(obj_Breast_AdenoCA$Y == 0)/nrow(obj_Breast_AdenoCA$Y))['SBS17b'], digits=3)*100`\% of cases and has an overall exposure of `r round((colSums(obj_Breast_AdenoCA$Y)/sum(obj_Breast_AdenoCA$Y))['SBS17b'], digits=3)*100`\%
\item SBS37 is 0 in `r round( (colSums(obj_Breast_AdenoCA$Y == 0)/nrow(obj_Breast_AdenoCA$Y))['SBS37'], digits=3)*100`\% of cases and has an overall exposure of `r round((colSums(obj_Breast_AdenoCA$Y)/sum(obj_Breast_AdenoCA$Y))['SBS37'], digits=3)*100`\%
\item SBS39 is 0 in `r round( (colSums(obj_Breast_AdenoCA$Y == 0)/nrow(obj_Breast_AdenoCA$Y))['SBS39'], digits=3)*100`\% of cases and has an overall exposure of `r round((colSums(obj_Breast_AdenoCA$Y)/sum(obj_Breast_AdenoCA$Y))['SBS39'], digits=3)*100`\%
\end{itemize}

\subsubsection{Betas}

```{r, Breast_AdenoCA_betas, echo=FALSE, fig.height=10}
ct <- "Breast-AdenoCA"

grid.arrange(plot_betas(diagRE_M[[ct]])+ggtitle(paste0(ct, '\n diagRE_M')),
plot_betas(fullRE_DMSL[[ct]])+ggtitle(paste0(ct, '\n fullRE_DMSL')),
plot_betas(diagRE_DMSL[[ct]])+ggtitle(paste0(ct, '\n diagRE_DMSL')),
plot_betas(sparseRE_DMSL[[ct]])+ggtitle(paste0(ct, '\n sparseRE_DMSL')),
plot_betas(additional_sorteddiagM[[ct]])+ggtitle(paste0(ct, '\n additional_sorteddiagM')),
plot_betas(additional_sorteddiagDM[[ct]])+ggtitle(paste0(ct, '\n additional_sorteddiagDM')),
  plot_betas(fullRE_M_nonexo[[ct]])+ggtitle(paste0(ct, '\n fullRE_M_nonexo')),
  plot_betas(fullRE_DMSL_nonexo[[ct]])+ggtitle(paste0(ct, '\n fullRE_DMSL_nonexo')),
  plot_betas(diagRE_DMSL_nonexo[[ct]])+ggtitle(paste0(ct, '\n diagRE_DMSL_nonexo')),
  plot_betas(sparseRE_DMSL_nonexo[[ct]])+ggtitle(paste0(ct, '\n sparseRE_DMSL_nonexo')), nrow=5)

```

```{r, Breast_AdenoCA_DA, echo=FALSE, message=FALSE, results='hide'}
ct <- "Breast-AdenoCA"
diagRE_DMSL_nonexo[[ct]]$phHess
pval_Breast_AdenoCA <- wald_TMB_wrapper(diagRE_DMSL_nonexo[[ct]])
```
We use the results from the diagonal single lambda DM to test for differential abundance, giving a p-value of `r pval_Breast_AdenoCA`.



\subsubsection{Covariance matrices}

```{r, Breast_AdenoCA_cov, echo=FALSE, message=FALSE, fig.height=3.7, fig.width=3.7}
ct <- "Breast-AdenoCA"
models_it_Breast_AdenoCA <- c('fullRE_M', 'fullRE_M_nonexo')
covmats_Breast_AdenoCA <- lapply(models_it_Breast_AdenoCA,
                                 function(i){
     fill_covariance_matrix(arg_d = length(python_like_select_name(get(i)[[ct]]$par.fixed, 'beta'))/2,
                            arg_entries_var = python_like_select_name(get(i)[[ct]]$par.fixed, 'logs_sd_RE'),
                            arg_entries_cov = python_like_select_name(get(i)[[ct]]$par.fixed, 'cov_par_RE'))
                                 })
names(covmats_Breast_AdenoCA) <- models_it_Breast_AdenoCA
## because it's fullRE_M, it's sorted
colnames(covmats_Breast_AdenoCA[['fullRE_M']]) <- rownames(covmats_Breast_AdenoCA[['fullRE_M']]) <- vector_cats_to_logR(colnames(sort_columns_TMB(obj_Breast_AdenoCA)$Y))
## because it's fullRE_M_nonexo, it's sorted
colnames(covmats_Breast_AdenoCA[['fullRE_M_nonexo']]) <- rownames(covmats_Breast_AdenoCA[['fullRE_M_nonexo']]) <- vector_cats_to_logR(colnames(give_subset_sigs_TMBobj(obj_Breast_AdenoCA, nonexogenous$V1)$Y))

for(i in 1:length(covmats_Breast_AdenoCA)){pheatmap(covmats_Breast_AdenoCA[[i]], cluster_rows = F, cluster_cols = F, main = models_it_bone_osteosarc[i])}
```

\subsubsection{Simulation under inferred data}

```{r, Breast_AdenoCA_sim, echo=FALSE}
sim_Breast_AdenoCA <- give_sim_from_estimates(enough_samples[2], "signatures", sigs_to_remove=unique(nonexogenous$V1),
                                              bool_give_PCA = T, path_to_data= "../../data/")
sim_Breast_AdenoCA[[2]]+ggtitle('Simulation of Breast Adenocarcinoma samples')
```

\subsubsection{Ranked plot for coverage}

```{r, Breast_AdenoCA_ranked_plot}
ct <- "Breast-AdenoCA"
integer_overdispersion_param_DMSL <- 1
obj_Breast_AdenoCA_nonexo <- give_subset_sigs_TMBobj(obj_Breast_AdenoCA, sigs_to_remove = nonexogenous$V1)
grid.arrange(give_interval_plots_2(df_rank = lapply(list(give_ranked_plot_simulation(tmb_fit_object = fullRE_M_nonexo[[ct]],
                 data_object = obj_Breast_AdenoCA_nonexo,
                 print_plot = F, nreps = 20, model = "M")), function(i){
                   lapply(i, function(j) cbind.data.frame(sorted_value=as.vector(j),
                                                          rank_number=1:length(j)) )})[[1]],
                 data_object = obj_Breast_AdenoCA_nonexo,
                 loglog = F, title = 'Breast_AdenoCA_nonexo (M)'),
 give_interval_plots_2(df_rank = lapply(list(give_ranked_plot_simulation(tmb_fit_object = fullRE_DMSL_nonexo[[ct]],
                 data_object = obj_Breast_AdenoCA_nonexo,
                 print_plot = F, nreps = 20, model = "DMSL", integer_overdispersion_param = integer_overdispersion_param_DMSL)), function(i){
                   lapply(i, function(j) cbind.data.frame(sorted_value=as.vector(j),
                                                          rank_number=1:length(j)) )})[[1]],
                 data_object = obj_Breast_AdenoCA_nonexo,
                 loglog = F, title = 'Breast_AdenoCA_nonexo (DMSL)'), ncol=2)
```


\subsubsection{Signatures from mutSigExtractor}

```{r, Breast_AdenoCA_mutsigextractor}
obj_Breast_AdenoCA_mutSigExtractor <- load_PCAWG(ct = "Breast-AdenoCA", typedata = "signaturesmutSigExtractor",
                                   path_to_data = "../../data/")
give_barplot_from_obj(obj = obj_Breast_AdenoCA_mutSigExtractor, legend_on = FALSE)
```





\subsection{Cervix-SCC}
\subsection{CNS-GBM}
\subsection{CNS-Medullo}
\subsection{CNS-Oligo}
\subsection{CNS-PiloAstro}
\subsection{ColoRect-AdenoCA}
\subsection{Eso-AdenoCA}
\subsection{Head-SCC}
\subsection{Kidney-ChRCC}
\subsection{Kidney-RCC.clearcell}
\subsection{Kidney-RCC.papillary}
\subsection{Liver-HCC}
\subsection{Lung-AdenoCA}
\subsection{Lung-SCC}
\subsection{Lymph-BNHL}
\subsection{Lymph-CLL}
\subsection{Myeloid-MPN}
\subsection{Ovary-AdenoCA}
\subsection{Panc-AdenoCA}
\subsection{Panc-Endocrine}
\subsection{Prost-AdenoCA}
\subsection{Skin-Melanoma.acral}
\subsection{Skin-Melanoma.cutaneous}
\subsection{Stomach-AdenoCA}
\subsection{Thy-AdenoCA}
\subsection{Uterus-AdenoCA}


\section{All p-values for non-exogenous signatures}

```{r, all_pvals, echo=FALSE, results='asis'}
all_pvals <- rbind.data.frame(cbind.data.frame(ct='Bone-Osteosarc', pvalue=pval_bone_osteosarc, model='diagRE_DMSL_nonexo'),
                              cbind.data.frame(ct='Breast-AdenoCA', pvalue=pval_Breast_AdenoCA, model='diagRE_DMSL_nonexo')
                              )

xtable::print.xtable(xtable::xtable(all_pvals), digits=c(0,10,0))

```

