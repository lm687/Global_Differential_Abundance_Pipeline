---
title: "Summary of TMB runs"
author: "Lena Morrill"
date: "24/05/2021"
output: pdf_document
header-includes:
   - \usepackage{array}
   - \setlength{\textwidth}{6.7in}
   - \setlength{\oddsidemargin}{-0.1in}
   - \setlength{\textheight}{8.6in}
   - \setlength{\topmargin}{-0.4in}
   - \newcolumntype{L}[1]{>{\raggedright\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}
   - \newcolumntype{C}[1]{>{\centering\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}
   - \newcolumntype{R}[1]{>{\raggedleft\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache=TRUE)
```

```{r libraries, echo=FALSE, message=FALSE, cache=TRUE, results='hide'}

library(Ternary)
library(MCMCpack)
library(TMB)
library(dplyr)
library(parallel)
library(umap)
library(gridExtra)
library(pheatmap)
library(ggplot2)
library(ggrepel)
library(RColorBrewer)

source("../2_inference_TMB/helper_TMB.R")
source("../../../CDA_in_Cancer/code/functions/meretricious/pretty_plots/prettySignatures.R")

TMB::compile("../2_inference_TMB/mm_multinomial/fullRE_dirichletmultinomial_single_lambda.cpp", "-std=gnu++17")
dyn.load(dynlib("../2_inference_TMB/mm_multinomial/fullRE_dirichletmultinomial_single_lambda"))
TMB::compile("../2_inference_TMB/mm_multinomial/fullRE_dirichletmultinomial_single_lambda2.cpp", "-std=gnu++17")
dyn.load(dynlib("../2_inference_TMB/mm_multinomial/fullRE_dirichletmultinomial_single_lambda2"))
TMB::compile("../2_inference_TMB/mm_multinomial/diagRE_dirichletmultinomial_single_lambda.cpp", "-std=gnu++17")
dyn.load(dynlib("../2_inference_TMB/mm_multinomial/diagRE_dirichletmultinomial_single_lambda"))
TMB::compile("../2_inference_TMB/mm_multinomial/diagRE_ME_dirichletmultinomial.cpp", "-std=gnu++17")
dyn.load(dynlib("../2_inference_TMB/mm_multinomial/diagRE_ME_dirichletmultinomial"))
TMB::compile("../../current/Dirichlet_Multinomial_Dom/code/TMB_models/sparseRE_ME_dirichletmultinomial.cpp", "-std=gnu++17")
dyn.load(dynlib("../../current/Dirichlet_Multinomial_Dom/code/TMB_models/sparseRE_ME_dirichletmultinomial"))
TMB::compile("../../current/Dirichlet_Multinomial_Dom/code/TMB_models/sparseRE_ME_dirichletmultinomialsinglelambda.cpp", "-std=gnu++17")
dyn.load(dynlib("../../current/Dirichlet_Multinomial_Dom/code/TMB_models/sparseRE_ME_dirichletmultinomialsinglelambda"))
TMB::compile("../../current/Dirichlet_Multinomial_Dom/code/TMB_models/sparseRE_ME_dirichletmultinomialsinglelambda2.cpp", "-std=gnu++17")
dyn.load(dynlib("../../current/Dirichlet_Multinomial_Dom/code/TMB_models/sparseRE_ME_dirichletmultinomialsinglelambda2"))
TMB::compile("../../current/Dirichlet_Multinomial_Dom/code/TMB_models/sparseRE_ME_dirichletmultinomial_singlecov.cpp", "-std=gnu++17")
dyn.load(dynlib("../../current/Dirichlet_Multinomial_Dom/code/TMB_models/sparseRE_ME_dirichletmultinomial_singlecov"))
TMB::compile("../2_inference_TMB/mm_multinomial/fullRE_ME_halfdirichletmultinomial.cpp", "-std=gnu++17")
dyn.load(dynlib("../2_inference_TMB/mm_multinomial/fullRE_ME_halfdirichletmultinomial"))
TMB::compile("../2_inference_TMB/mm_multinomial/fullRE_ME_dirichletmultinomial.cpp", "-std=gnu++17")
dyn.load(dynlib("../2_inference_TMB/mm_multinomial/fullRE_ME_dirichletmultinomial"))
TMB::compile("../2_inference_TMB/mm_multinomial/diagRE_ME_dirichletmultinomial.cpp", "-std=gnu++17")
dyn.load(dynlib("../2_inference_TMB/mm_multinomial/diagRE_ME_dirichletmultinomial"))
TMB::compile("../2_inference_TMB/mm_multinomial/diagRE_ME_multinomial.cpp", "-std=gnu++17")
dyn.load(dynlib("../2_inference_TMB/mm_multinomial/diagRE_ME_multinomial"))
TMB::compile("../2_inference_TMB/mm_multinomial/fullRE_ME_multinomial.cpp", "-std=gnu++17")
dyn.load(dynlib("../2_inference_TMB/mm_multinomial/fullRE_ME_multinomial"))


```

```{r,, load_functions, cache=FALSE, echo=FALSE}

library(viridis)
library(grid)
library(readxl)

source("../2_inference_TMB/helper_TMB.R")
source("../../../CDA_in_Cancer/code/functions/meretricious/pretty_plots/prettySignatures.R")
source("../1_create_ROO/roo_functions.R")
source("../3_analysis/helper/pcawg.colour.palette.R")

## additional libraries
# library(tikzDevice) ## for computer modern font
# library(extrafont) ## for computer modern font
# font_import(pattern = "lmodern*")
```

```{r, read_ct, echo=FALSE, warning=FALSE, message=FALSE, cache=F}
enough_samples = read.table("../../data/restricted/pcawg/CT_sufficient_samples.txt", comment.char='#')[,1]
nonexogenous = read.table("../../data/cosmic/exogenous_signatures_SBS.txt", sep = "\t",
                          comment.char = "#", fill = F)
subset_sigs_sparse_cov_idx_nonexo <- read.table("../../current/subset_sigs_sparse_cov_idx_nonexo.txt", stringsAsFactors = F, fill = T)
fles_roo <- list.files("../../data/roo/", full.names = T)

```


\section{Using subset of active signatures from the PCAWG paper}
```{r, sigs_from_paper, warning=F, echo=F}
cts_for_PCAWG <- gsub("_signaturesPCAWG_ROO.RDS", "",
                                basename(fles_roo[grepl('_signaturesPCAWG_',
                                                        fles_roo)]))
signatures_PCAWG <- sapply(cts_for_PCAWG,
       load_PCAWG, typedata = "signaturesPCAWG",
       path_to_data = "../../data/")
names(signatures_PCAWG) <- cts_for_PCAWG
```

```{r, sigs_from_paper2, warning=F, echo=F, fig.height=2.4}
# give_barplot_from_obj(obj = signatures_PCAWG[[1]], legend_on = FALSE, nrow=1, verbose=F, only_normalised=T)
sapply(cts_for_PCAWG, function(i){
  try(print(give_barplot_from_obj(obj = signatures_PCAWG[[i]], legend_on = T,
                        nrow=1, verbose=F,
                        only_normalised=T, title=i)))})

```

```{r, load_runs_signaturesPCAWG,echo=F}
fullRE_M_SP <- sapply(enough_samples, function(ct){
  try(readRDS(paste0("../../data/pcawg_robjects_cache/tmb_results/nlminb/fullREM_", ct, "_signaturesPCAWG.RDS")))
}, simplify = F); names(fullRE_M_SP) <- enough_samples
fullRE_DMSL_SP <- sapply(enough_samples, function(ct){
  try(readRDS(paste0("../../data/pcawg_robjects_cache/tmb_results/nlminb/fullREDMsinglelambda_", ct, "_signaturesPCAWG.RDS")))
}, simplify = F); names(fullRE_DMSL_SP) <- enough_samples

fullRE_M_nonexo_SP <- sapply(enough_samples, function(ct){
  try(readRDS(paste0("../../data/pcawg_robjects_cache/tmb_results/nlminb/fullREMnonexo_", ct, "_signaturesPCAWG.RDS")))
}, simplify = F); names(fullRE_M_nonexo_SP) <- enough_samples
fullRE_DMSL_nonexo_SP <- sapply(enough_samples, function(ct){
  try(readRDS(paste0("../../data/pcawg_robjects_cache/tmb_results/nlminb/fullREDMsinglelambdanonexo_", ct, "_signaturesPCAWG.RDS")))
}, simplify = F); names(fullRE_DMSL_nonexo_SP) <- enough_samples

diagRE_DMDL_SP <- sapply(enough_samples, function(ct){
  try(readRDS(paste0("../../data/pcawg_robjects_cache/tmb_results/nlminb/diagREDM_", ct, "_signaturesPCAWG.RDS")))
}, simplify = F); names(diagRE_DMDL_SP) <- enough_samples
diagRE_DMDL_nonexo_SP <- sapply(enough_samples, function(ct){
  try(readRDS(paste0("../../data/pcawg_robjects_cache/tmb_results/nlminb/diagREDMnonexo_", ct, "_signaturesPCAWG.RDS")))
}, simplify = F); names(diagRE_DMDL_nonexo_SP) <- enough_samples

"../../data/pcawg_robjects_cache/tmb_results/nlminb/fullREDM"
# fullREDMnoscaling_SP <- sapply(enough_samples, function(ct){
#   try(readRDS(paste0("../../data/pcawg_robjects_cache/tmb_results/nlminb/fullREDMnoscaling_", ct, "_signaturesPCAWG.RDS")))
# }, simplify = F); names(fullREDMnoscaling_SP) <- enough_samples
fullREDMnoscaling_SP_nonexo <- sapply(enough_samples, function(ct){
  try(readRDS(paste0("../../data/pcawg_robjects_cache/tmb_results/nlminb/fullREDMnoscalingnonexo_", ct, "_signaturesPCAWG.RDS")))
}, simplify = F); names(fullREDMnoscaling_SP_nonexo) <- enough_samples

fullREDMnoscaling_SP_nonexo_subsets_and_amalgamations <- sapply(enough_samples, function(ct){
  try(readRDS(paste0("../../data/pcawg_robjects_cache/tmb_results/nlminb/fullREDMnoscalingnonexosubset_", ct, "_signaturesPCAWG.RDS")))
}, simplify = F); names(fullREDMnoscaling_SP_nonexo_subsets_and_amalgamations) <- enough_samples

fullREDMnoscaling_SP_nonexo_subsets_and_amalgamations[give_summary_of_runs2(fullREDMnoscaling_SP_nonexo_subsets_and_amalgamations, long_return = T)$Timeout] <- fullREDMnoscaling_SP_nonexo [give_summary_of_runs2(fullREDMnoscaling_SP_nonexo_subsets_and_amalgamations, long_return = T)$Timeout]

fullREDMonefixedlambdanonexo_SP <- sapply(enough_samples, function(ct){
  try(readRDS(paste0("../../data/pcawg_robjects_cache/tmb_results/nlminb/fullREDMonefixedlambdanonexo_", ct, "_signaturesPCAWG.RDS")))
}, simplify = F); names(fullREDMonefixedlambdanonexo_SP) <- enough_samples

fullREDMonefixedlambda2nonexo_SP <- sapply(enough_samples, function(ct){
  try(readRDS(paste0("../../data/pcawg_robjects_cache/tmb_results/nlminb/fullREDMonefixedlambda2nonexo_", ct, "_signaturesPCAWG.RDS")))
}, simplify = F); names(fullREDMonefixedlambda2nonexo_SP) <- enough_samples

fullREDMonefixedlambdanonexo_SPSaA <- sapply(enough_samples, function(ct){
  try(readRDS(paste0("../../data/pcawg_robjects_cache/tmb_results/nlminb/fullREDMonefixedlambdanonexo_", ct, "_signaturesPCAWGSaA.RDS")))
}, simplify = F); names(fullREDMonefixedlambdanonexo_SPSaA) <- enough_samples
```

```{r, p_vals_SP, dependson=c('load_runs_signaturesPCAWG')}

pvals_diagRE_DMDL_SP <- sapply(diagRE_DMDL_SP, function(i) try(wald_TMB_wrapper(i)))
pvals_diagRE_DMDL_nonexo_SP <- sapply(diagRE_DMDL_nonexo_SP, function(i) try(wald_TMB_wrapper(i)))
pvals_fullRE_M_nonexo_SP <- sapply(fullRE_M_nonexo_SP, function(i) try(wald_TMB_wrapper(i)))
pvals_fullRE_DMSL_nonexo_SP <- sapply(fullRE_DMSL_nonexo_SP, function(i) try(wald_TMB_wrapper(i)))
pvals_fullREDMnoscaling_SP_nonexo_subsets_and_amalgamations <- sapply(fullREDMnoscaling_SP_nonexo_subsets_and_amalgamations, function(i) try(wald_TMB_wrapper(i)))
pvals_fullREDMonefixedlambdanonexo_SP <- sapply(fullREDMonefixedlambdanonexo_SP, function(i) try(wald_TMB_wrapper(i)))
pvals_fullREDMonefixedlambdanonexo_SPSaA <- sapply(fullREDMonefixedlambdanonexo_SPSaA, function(i) try(wald_TMB_wrapper(i)))


names(fullREDMonefixedlambdanonexo_SPSaA) <- names(pvals_fullREDMonefixedlambdanonexo_SP) <- names(pvals_fullREDMnoscaling_SP_nonexo_subsets_and_amalgamations) <- names(pvals_diagRE_DMDL_SP) <- names(pvals_diagRE_DMDL_nonexo_SP) <- names(pvals_fullRE_M_nonexo_SP) <- 
  names(pvals_fullRE_DMSL_nonexo_SP) <- enough_samples
```

```{r, pvals_diagRE_DMDL_SP_DA, dependson=c('p_vals_SP')}
pvals_diagRE_DMDL_SP

```

```{r, summary_convergence_SP, fig.height=6.2, fig.width=7, echo=FALSE, dependson=c('read_tmb_runs', 'load_runs_signaturesPCAWG')}
list_models_SP <- c( 'fullRE_M_SP', 'fullRE_DMSL_SP',
                  'fullRE_M_nonexo_SP','fullRE_DMSL_nonexo_SP',
                  'diagRE_DMDL_SP',
                  'diagRE_DMDL_nonexo_SP', 'fullREDMnoscaling_SP_nonexo',
                  'fullREDMnoscaling_SP_nonexo_subsets_and_amalgamations',
                  'fullREDMonefixedlambdanonexo_SP', 'fullREDMonefixedlambda2nonexo_SP',
                  'fullREDMonefixedlambdanonexo_SPSaA')
# list_models_SP <- c( 'fullRE_M_SP', 'fullRE_DMSL_SP',
#                   'fullRE_M_nonexo_SP','fullRE_DMSL_nonexo_SP',
#                   'diagRE_DMDL_SP',
#                   'diagRE_DMDL_nonexo_SP', 'fullREDMnoscaling_SP_nonexo',
#                   'fullREDMnoscaling_SP_nonexo_subsets_and_amalgamations', 'fullREDMonefixedlambdanonexo_SP')

give_summary_of_runs2(fullREDMonefixedlambdanonexo_SPSaA, long_return=T)

all_summaries_SP <- lapply(lapply(list_models_SP, get), function(i){
    give_summary_of_runs2(i, long_return = T)})
names(all_summaries_SP) <- list_models_SP

ggplot(melt(all_summaries_SP), aes(x=factor(L1, levels=list_models_SP), y=value, fill=L2))+geom_tile()+
  theme(axis.text.x=element_text(angle = 45, hjust = 1, vjust=1))+
  # theme(legend.position = "bottom")+
  labs(x='')


```

```{r}
## comparison of betas
# give_betas(get(list_models_SP)[[1]][[1]])
all_betas_SP <- do.call('cbind', lapply(c( 'fullRE_M_SP', 'fullRE_DMSL_SP',
                  'diagRE_DMDL_SP'), function(j) do.call('c', sapply(get(j), function(i) as.vector(give_betas(i))))))
colnames(all_betas_SP) <- c( 'fullRE_M_SP', 'fullRE_DMSL_SP',
                  'diagRE_DMDL_SP')
pairs(all_betas_SP)
all_betas_SP_nonexo <- do.call('cbind', lapply(c('fullRE_M_nonexo_SP','fullRE_DMSL_nonexo_SP', 
                  'diagRE_DMDL_nonexo_SP', 'fullREDMnoscaling_SP_nonexo'), function(j) do.call('c', sapply(get(j), function(i) as.vector(give_betas(i))))))
colnames(all_betas_SP_nonexo) <- c('fullRE_M_nonexo_SP','fullRE_DMSL_nonexo_SP',
                                   'diagRE_DMDL_nonexo_SP', 'fullREDMnoscaling_SP_nonexo')
pairs(all_betas_SP_nonexo)
```

```{r, names_logR_SP, dependson=c('load_runs_signaturesPCAWG'), echo=FALSE}
## for names of betas
colnames_all_sorted_SP <- list()
logR_all_sorted_SP <- list()
colnames_nonexo_sorted_SP <- list()
logR_nonexo_sorted_SP <- list()
colnames_nonexo_notsorted_SP <- list()
logR_nonexo_notsorted_SP <- list()

for(ct in enough_samples){

  colnames_all_sorted_SP[[ct]] <- colnames(sort_columns_TMB(load_PCAWG(ct = ct, typedata = "signaturesPCAWG",
                                     path_to_data = "../../data/"))$Y)
  logR_all_sorted_SP[[ct]] <- vector_cats_to_logR(colnames_all_sorted_SP[[ct]])
  colnames_nonexo_sorted_SP[[ct]] <- colnames(sort_columns_TMB(give_subset_sigs_TMBobj(load_PCAWG(ct = ct, typedata = "signaturesPCAWG",
                                     path_to_data = "../../data/"), nonexogenous$V1))$Y)
  logR_nonexo_sorted_SP[[ct]] <- vector_cats_to_logR(colnames_nonexo_sorted_SP[[ct]])
  colnames_nonexo_notsorted_SP[[ct]] <- colnames(give_subset_sigs_TMBobj(load_PCAWG(ct = ct, typedata = "signaturesPCAWG",
                                     path_to_data = "../../data/"), nonexogenous$V1)$Y)
  logR_nonexo_notsorted_SP[[ct]] <- vector_cats_to_logR(colnames_nonexo_notsorted_SP[[ct]])
}

```

## differences between signatures from sigprofiler from the paper, and the ones I get

- biliary adenoca similar, though not exact
- bladder tcc: very similar
- bone benign: similar
- bone epith: extremely similar
- bone osteosarc: I have a lot of SBS8, which they don't. Other than that, similar
- breast adenicaL I have a lot of SBS9, which  they don't. Other than that, similar
- breast DCIS: I have more SBS40 than they do
- breast lobularca: very similar
- cervix adenoca: very similar
- cervix SCC: very similar, although I have more SBS40
- CNS GBM: very similar, mine seem to be more homogeneous
- CNS medullo: very similar, mine seem to be more homogeneous
- CNS oligo: very similar, mine seem to be more homogeneous
- CNS piloastro: very similar, mine seem to be more homogeneous
- Colorect adenoca: quite similar
- eso adenoca: very similar
- head scc: very similar, mine seem to be more homogeneous
- kidney chrcc: very similar
- kidney rcc.clearcell: very similar, although I have more SBS29
- kidney papillary: only I have it
- liver hcc: different. I have a lot of SBS40 and SBS12, they have mostly SBS5 ***
- lung adenoca: very similar
- lung SCC: very similar, though I have more SBS8
- lymph BNHL: very similar
- Lymph CLL: very similar, althpugh theirs are much more sparse
- myeloid AML: very similar, although I don't have any SBS60 and they seem to have
- myeloid MDS: I don't have it
- myeloid MPN: similar, although mine is much more sparse
- ovary adenoca: different. I have a lot of SBS40, which in their case is rare, and they have much more of SBS3 than I do ***
- panc-adenoca: different. I have a lot of SBS8 that they don't have. ***
- panc-endocrine: sort of similar. I have more SBS8 than they and they have more SBS5
- Prost-adenoca: sort of similar, I have more SBS8
- skin-melanoma.acral: they don't have this category. They have "skin-melanoma", which might be both together? (!!!) Similar exposures...
- softtissue-leiomyo: very similar exposures
- softtissue-liposarc: very similar exposures
- stomach adenoca: very similar, mine seem to be more homogeneous
- thy-adenoca: very similar
- uterus-adenoca: very similar

```{r, signaturesPCAWG_names_sigs,echo=F, dependson=c('load_runs_signaturesPCAWG')}
colnames_notsorted_SP <- list()
logR_notsorted_SP <- list()
colnames_nonexo_notsorted_SP <- list()
logR_nonexo_notsorted_SP <- list()

for(ct in enough_samples){
    colnames_notsorted_SP[[ct]] <- try(colnames(load_PCAWG(ct = ct, typedata = "signaturesPCAWG",
                                                 path_to_data = "../../data/")$Y))
  logR_notsorted_SP[[ct]] <- try(vector_cats_to_logR(colnames_notsorted_SP[[ct]]))
  
  colnames_nonexo_notsorted_SP[[ct]] <- try(colnames(give_subset_sigs_TMBobj(load_PCAWG(ct = ct, typedata = "signaturesPCAWG",
                                                 path_to_data = "../../data/"), nonexogenous$V1)$Y))
  logR_nonexo_notsorted_SP[[ct]] <- try(vector_cats_to_logR(colnames_nonexo_notsorted_SP[[ct]]))
}
```

\section{Betas from PCAWG subset of signatures}
Reminder that the clonesig signatures were a subset of WES data.

```{r, plot_betas_signaturesPCAWG, echo=F, fig.height=2, warning=FALSE, dependson=c('load_runs_signaturesPCAWG')}

for(ct in enough_samples){
  grid.arrange(plot_betas(fullRE_M_SP[[ct]], only_slope=T, plot=F,
                          names_cats=logR_notsorted_SP[[ct]], title = 'fullRE M'),
               plot_betas(fullRE_DMSL_SP[[ct]], only_slope=T, plot=F,
                          names_cats=logR_notsorted_SP[[ct]], title = 'fullRE DMSL'),
               plot_betas(fullRE_M_nonexo_SP[[ct]], only_slope=T, plot=F,
                          names_cats=logR_nonexo_notsorted_SP[[ct]], title = 'fullRE M\nnonexo'),
               plot_betas(fullRE_DMSL_nonexo_SP[[ct]], only_slope=T, plot=F,
                          names_cats=logR_nonexo_notsorted_SP[[ct]], title = 'fullRE DMSL\nnonexo'),
               top=ct, nrow=1)
}

```

\section{Overdispersion parameters in double-lambda DM}
```{r, overdispersion_params_groups, dependson=c('load_runs_signaturesPCAWG'), fig.width=8.5, fig.height=7}
ovrdisp <- do.call('rbind.data.frame', lapply(1:length(diagRE_DMDL_nonexo_SP), try(function(idx){
  if(diagRE_DMDL_nonexo_SP[[idx]]$pdHess){
    cbind.data.frame( plot_lambdas(diagRE_DMDL_nonexo_SP[[idx]], return_df=T, plot=F), ct=names(diagRE_DMDL_nonexo_SP)[idx])
  }else{
    c(NA, NA)
  }
})))
ovrdisp[ovrdisp$name == 'Lambda 1','name'] = 'Early'
ovrdisp[ovrdisp$name == 'Lambda 2','name'] = 'Late'

ggplot(ovrdisp, aes(x=name,  y=`Estimate`))+
  geom_point()+
  geom_errorbar(aes(ymin=`Estimate`-`Std..Error`,
                    ymax=`Estimate`+`Std..Error`), width=.1)+
  theme_bw()+
  facet_wrap(.~ct, scales = "free_y", nrow=6)+
  labs(x='', y='Log lambda')


```


Test for differential precision (1/overdispersion) parameter
```{r, overdispersion_params_groups_test}
differential_precision <- p.adjust(sapply(diagRE_DMDL_nonexo_SP, wald_TMB_wrapper_overdisp), method = 'fdr')
names(differential_precision) <- names(diagRE_DMDL_nonexo_SP)
sort(differential_precision)
table(differential_precision <= 0.05)
differential_precision[(differential_precision <= 0.05)]
```


```{r, overdispersion_params_groups_2, dev='tikz', dependson=c('load_runs_signaturesPCAWG')}
ovrdisp$differentially_abundant = ifelse(ovrdisp$ct %in% names(differential_precision[(differential_precision <= 0.05)]), yes = '*', no = '')
ovrdisp$differentially_abundant
ggplot(ovrdisp, aes(x=ct,  y=`Estimate`, group=name, col=name))+
  geom_point(position=position_dodge(width=0.5))+
  geom_errorbar(aes(ymin=`Estimate`-`Std..Error`,
                    ymax=`Estimate`+`Std..Error`), width=.1, position=position_dodge(width=0.5))+
  theme_bw()+
  geom_text(aes(y=Inf, label=differentially_abundant, vjust=1.8), col='black')+
  theme(axis.text.x=element_text(angle = 45, hjust = 1, vjust=1))+
  labs(x='', y='Log lambda', col='Group')+theme(legend.position = "bottom")+
    theme(        legend.margin=margin(0,0,0,0),
                  legend.box.margin=margin(-10,-10,-10,-10),
                  plot.margin = unit(c(1,1,1,1), "cm"))
```



Test for differential precision (1/overdispersion) parameter
```{r, overdispersion_params_groups_test_2}
differential_precision_2 <- p.adjust(sapply(diagRE_DMDL_nonexo_SP, ttest_TMB_wrapper_overdisp), method = 'fdr')
names(differential_precision_2) <- names(diagRE_DMDL_nonexo_SP)
sort(differential_precision_2)
table(differential_precision_2 <= 0.05)
differential_precision_2[(differential_precision_2 <= 0.05)]

ovrdisp$differential_precision_2 = ifelse(ovrdisp$ct %in% names(differential_precision_2[(differential_precision_2 <= 0.05)]), yes = '*', no = '')

ggplot(ovrdisp, aes(x=ct,  y=`Estimate`, group=name, col=name))+
  geom_point(position=position_dodge(width=0.5))+
  geom_errorbar(aes(ymin=`Estimate`-`Std..Error`,
                    ymax=`Estimate`+`Std..Error`), width=.1, position=position_dodge(width=0.5))+
  theme_bw()+
  geom_text(aes(y=Inf, label=differential_precision_2, vjust=1.8), col='black')+
  theme(axis.text.x=element_text(angle = 45, hjust = 1, vjust=1))+
  labs(x='', y='Log lambda', col='Group')+theme(legend.position = "bottom")+
    theme(        legend.margin=margin(0,0,0,0),
                  legend.box.margin=margin(-10,-10,-10,-10),
                  plot.margin = unit(c(1,1,1,1), "cm"))
```



\section{Minimal perturbation}
Note: this is using the original, non SP, signatures (hence not the best version).
```{r, minimal_pert_1, dependson=c('load_runs_signaturesPCAWG')}
minimalpert_L2 <- function(i){
  sum(i)/sum(i^2)
}
# 
# betas_breast <- data.frame(plot_betas(diagRE_DMSL_nonexo[["Breast-AdenoCA"]], names_cats= logR_nonexo_notsorted[["Breast-AdenoCA"]],
#                            return_df=T, plot=F))
# 
# .slopes_minpert <- betas_breast %>% dplyr::filter(type_beta == "Slope") %>% dplyr::select(Estimate) %>% unlist()
# 
# # minimalpert_L2(softmax(c(.slopes_minpert, 0)))
# median(c(.slopes_minpert, 0))
# 
# aa <- plot_betas(diagRE_DMSL_nonexo[["Breast-AdenoCA"]], names_cats= logR_nonexo_notsorted[["Breast-AdenoCA"]],
#                            return_df=F, plot=F, only_slope = T, line_zero=F)
# # aa <- geom_hline(yintercept = 0)+geom_vline(xintercept = 1)+geom_hline(yintercept = median(c(.slopes_minpert, 0)), lty='dashed', col='blue')
# aa + geom_hline(yintercept = median(c(.slopes_minpert, 0)), lty='dashed', col='blue')+
#   geom_hline(yintercept = mean(c(.slopes_minpert, 0)), lty='dashed', col='red')

```

For the thesis:
```{r, thesis_minimal_perturbation, echo=F, fig.height=2.4, fig.width=3, dev='tikz', dependson=c('load_runs_signaturesPCAWG')}

# betas_breast <- data.frame(plot_betas(diagRE_DMSL_nonexo[["Breast-AdenoCA"]], names_cats= logR_nonexo_notsorted[["Breast-AdenoCA"]],
#                            return_df=T, plot=F))
# .slopes_minpert <- betas_breast %>% dplyr::filter(type_beta == "Slope") %>% dplyr::select(Estimate) %>% unlist()
# 
# aa <- plot_betas(TMB_obj = diagRE_DMSL_nonexo[["Breast-AdenoCA"]], names_cats= logR_nonexo_notsorted[["Breast-AdenoCA"]],
#                            return_df=F, plot=F, only_slope = T, line_zero=F, add_confint =F)
# aa + geom_hline(yintercept = median(c(.slopes_minpert, 0)), lty='dashed', col='blue')


betas_breast <- data.frame(plot_betas(TMB_obj = diagRE_DMDL_nonexo_SP[["Breast-AdenoCA"]],
                                      names_cats= logR_nonexo_notsorted_SP[["Breast-AdenoCA"]],
                           return_df=T, plot=F))
.slopes_minpert <- betas_breast %>% dplyr::filter(type_beta == "Slope") %>% dplyr::select(Estimate) %>% unlist()
aaa <- plot_betas(TMB_obj = diagRE_DMDL_nonexo_SP[["Breast-AdenoCA"]],
                  names_cats= logR_nonexo_notsorted_SP[["Breast-AdenoCA"]],
                  return_df=F, plot=T, only_slope = T, line_zero=F, add_confint = T, return_plot = F, return_ggplot = T)
(aaa) + geom_hline(yintercept = median(c(.slopes_minpert, 0)), lty='dashed', col='blue')+ggtitle("")+labs(x='Log ratio of signatures')+
  theme(strip.background = element_blank(), strip.text = element_blank()) 

```


```{r, minimalperturbation_allplots, dependson=c('load_runs_signaturesPCAWG')}
pdf("../../results/results_TMB/pcawg/minimalperturbation_SP_all.pdf", width = 4, height = 3)
for(ct in names(diagRE_DMDL_nonexo_SP)){
  .betas_ct_it <- data.frame(plot_betas(TMB_obj = diagRE_DMDL_nonexo_SP[[ct]],
                                        names_cats= logR_nonexo_notsorted_SP[[ct]],
                             return_df=T, plot=F))
  .slopes_minpert <- .betas_ct_it %>% dplyr::filter(type_beta == "Slope") %>% dplyr::select(Estimate) %>% unlist()
  print(aaa <- plot_betas(TMB_obj = diagRE_DMDL_nonexo_SP[[ct]], names_cats= logR_nonexo_notsorted_SP[[ct]],
                             return_df=F, plot=F, only_slope = T, line_zero=F, add_confint = T, return_ggplot=T, return_plot = F)
        +
          geom_hline(yintercept = median(c(.slopes_minpert, 0)), lty='dashed', col='blue')+ggtitle(ct))
}
dev.off()
```

\subsection{Minimal perturbation in diagRE_DMDL_nonexo_S}
```{r, minimalperturbation_diagRE_DMDL_nonexo_S, dependson=c('load_runs_signaturesPCAWG')}

perturbed_betas_diagRE_DMDL_nonexo_SP <- lapply(names(diagRE_DMDL_nonexo_SP), try(function(idx_sp){
  .betas_SP <- data.frame(plot_betas(diagRE_DMDL_nonexo_SP[[idx_sp]], names_cats= logR_nonexo_notsorted_SP[[idx_sp]],
                             return_df=T, plot=F))
  
  .slopes_minpert_SP <- .betas_SP %>% dplyr::filter(type_beta == "Slope") %>% dplyr::select(Estimate) %>% unlist()
  # print(.slopes_minpert_SP)
  ## check if the CI of the betas touches this median value
  .summary_betas_slope_SP <- python_like_select_rownames(summary(diagRE_DMDL_nonexo_SP[[idx_sp]]), 'beta')[c(F,T),]
  nrow(.summary_betas_slope_SP)
  
  minimal_change_baseline <- median(c(.slopes_minpert_SP, 0))
  # print(.summary_betas_slope_SP)
  # print(logR_nonexo_notsorted_SP[[idx_sp]])
  # print(dim(.summary_betas_slope_SP))
  if(!is.null(dim(.summary_betas_slope_SP))){
    .params_in_ci <- give_params_in_CI(vec_est=.summary_betas_slope_SP[,1],
                      vec_stderr=.summary_betas_slope_SP[,2],
                      vec_true=rep(minimal_change_baseline, nrow(.summary_betas_slope_SP)))
  }else{
    .params_in_ci <- give_params_in_CI(vec_est=.summary_betas_slope_SP[1],
                      vec_stderr=.summary_betas_slope_SP[2],
                      vec_true=minimal_change_baseline)
  }
  .params_in_ci <- sapply(1:length(.params_in_ci), function(i){
      ## for the ones in which there is a change, say whether it's up- or down-regulated
      if(!.params_in_ci[i]){
        ## if there is a change: not in confidence interval
        if(is.null(dim(.summary_betas_slope_SP))){
          ## one-dim
          if(.summary_betas_slope_SP[1] > minimal_change_baseline){
            'increase'
          }else{
            'decrease'
          }
        }else{
          ## multi-dim
          if(.summary_betas_slope_SP[i,1] > minimal_change_baseline){
            'increase'
          }else{
            'decrease'
          }
        }
      }else{
        'FALSE'
      }
    })
  names(.params_in_ci) <- sapply(logR_nonexo_notsorted_SP[[idx_sp]], function(i) strsplit(i, '/')[[1]][1])
  .baseline <- strsplit(logR_nonexo_notsorted_SP[[idx_sp]][[1]], '/')[[1]][2]
  return(list(betas_perturbed=.params_in_ci, baseline=.baseline))
}))


```

```{r, minimalperturbation_diagRE_DMDL_nonexo_S_2, dependson=c('minimalperturbation_diagRE_DMDL_nonexo_S', 'load_runs_signaturesPCAWG'), dev='tikz'}

perturbed_betas_diagRE_DMDL_nonexo_SP_vec <- do.call('c', sapply(perturbed_betas_diagRE_DMDL_nonexo_SP, function(i) i[1]))

perturbed_betas_diagRE_DMDL_nonexo_SP_df <- cbind.data.frame(sig=gsub("betas_perturbed.", "",
                                                                      names(perturbed_betas_diagRE_DMDL_nonexo_SP_vec)),
                                                             perturbed=perturbed_betas_diagRE_DMDL_nonexo_SP_vec)
ggplot(perturbed_betas_diagRE_DMDL_nonexo_SP_df, aes(x=factor(sig, levels=gtools::mixedsort(unique(sig))),
                                                     fill=factor(perturbed, levels=c('increase', 'decrease', 'FALSE'))))+
  geom_bar(col='black', size=0.001)+theme_bw()+
  scale_fill_manual(values=c( '#b1d8b7', '#f08080', '#e7feff'))+
  theme(axis.text.x=element_text(angle = 45, hjust = 1, vjust=1), legend.position = "bottom")+
  labs(x='Signatures', y='Number of putatively perturbed\n and unperturbed signatures', fill='Perturbed')

```

Minimal perturbation per signature
```{r, minimalperturbation_diagRE_DMDL_nonexo_S_3, dependson=c('minimalperturbation_diagRE_DMDL_nonexo_S', 'load_runs_signaturesPCAWG'), dev='tikz'}
names(perturbed_betas_diagRE_DMDL_nonexo_SP) <- names(diagRE_DMDL_nonexo_SP)
ggplot(reshape2::melt(lapply(perturbed_betas_diagRE_DMDL_nonexo_SP, `[`, 'betas_perturbed')),
       aes(x=L1, fill=factor(value, levels=c('increase', 'decrease', 'FALSE'))))+geom_bar(col='black', size=0.001)+theme_bw()+
        scale_fill_manual(values=c('#b1d8b7', '#f08080', '#e7feff'))+theme(legend.position = "bottom")+
    theme(axis.text.x=element_text(angle = 45, hjust = 1, vjust=1))+labs(x='Cancer type',
                                                                         y='Number of putatively perturbed\n and unperturbed signatures',  fill='Perturbed')

```

```{r, hehehhee}

```

Table of perturbed signatures
```{r, table_minimal_pert, dependson=c('minimalperturbation_diagRE_DMDL_nonexo_S', 'load_runs_signaturesPCAWG')}
relevel_perturbation <- cbind(c('increase', 'decrease'), c('+', '-'))

write("", "../../results/results_TMB/pcawg/minimal_perturbation_sigs.txt", append = F)
# for(i in names(perturbed_betas_diagRE_DMDL_nonexo_SP)){
#   write(paste0(i, '&', paste0(names(perturbed_betas_diagRE_DMDL_nonexo_SP[[i]]$betas_perturbed)[perturbed_betas_diagRE_DMDL_nonexo_SP[[i]]$betas_perturbed], collapse = ", "), '\\\\'), "../../results/results_TMB/pcawg/minimal_perturbation_sigs.txt", append = T)
# }
for(i in names(perturbed_betas_diagRE_DMDL_nonexo_SP)){
  # write(x = paste0(i, '&', paste0(sapply(which(perturbed_betas_diagRE_DMDL_nonexo_SP[[i]]$betas_perturbed != 'FALSE'), function(j){
  #     paste0(names(perturbed_betas_diagRE_DMDL_nonexo_SP[[i]]$betas_perturbed)[j], '(', relevel_perturbation[match(perturbed_betas_diagRE_DMDL_nonexo_SP[[i]]$betas_perturbed[j], relevel_perturbation[,1]),2] , ')', collapse='', sep='')
  #   }), collapse=', ', sep=''), '\\\\'),  file="../../results/results_TMB/pcawg/minimal_perturbation_sigs.txt", append = T)
    write(x = paste0(paste0(i, '&', paste0(sapply(which(perturbed_betas_diagRE_DMDL_nonexo_SP[[i]]$betas_perturbed != 'FALSE'), function(j){
      paste0(names(perturbed_betas_diagRE_DMDL_nonexo_SP[[i]]$betas_perturbed)[j], ' (', relevel_perturbation[match(perturbed_betas_diagRE_DMDL_nonexo_SP[[i]]$betas_perturbed[j], relevel_perturbation[,1]),2] , ')', collapse='', sep='')
    }), collapse=', ', sep=''), '\\\\')),  file="../../results/results_TMB/pcawg/minimal_perturbation_sigs.txt", append = T)
}

```

```{r, effectsize1_SP, dependson=c('load_objects_all', 'load_runs_signaturesPCAWG'), echo=F, fig.height=4.5, fig.width=4}
all_objects_SP <- lapply(enough_samples, function(ct){load_PCAWG(ct = ct, typedata = "signaturesPCAWG")})
names(all_objects_SP) <- enough_samples
all_objects_nonexo_SP <- lapply(enough_samples, function(ct){
  try(give_subset_sigs_TMBobj(all_objects_SP[[ct]],
                       sigs_to_remove = unique(nonexogenous$V1)))
})
names(all_objects_nonexo_SP) <- enough_samples

num_samples_all_SP <- sapply(enough_samples, function(ct){
    .xx <- all_objects_SP[[ct]]
    try(nrow(.xx$Y)/2)
})
num_samples_nonexo_SP <- sapply(enough_samples, function(ct){
    .xx <- all_objects_nonexo_SP[[ct]]
    try(nrow(.xx$Y)/2)
})

num_sigs_SP <- sapply(enough_samples, function(ct){
    .xx <- all_objects_SP[[ct]]
    try(ncol(.xx$Y))
})

num_sigs_nonexo_SP <- sapply(enough_samples, function(ct){
    .xx <- all_objects_nonexo_SP[[ct]]
    try(ncol(.xx$Y))
})



effect_size1nonexo_SP <- sapply(enough_samples, function(ct){
  .xx <- all_objects_nonexo_SP[[ct]]
  print(dim(.xx$Y[1:(nrow(.xx$Y)/2),]))
  print(dim(.xx$Y[(1+nrow(.xx$Y)/2):(nrow(.xx$Y)),]))
  try(compute_effect_size_1(mat1 = .xx$Y[1:(nrow(.xx$Y)/2),], mat2 = .xx$Y[(1+nrow(.xx$Y)/2):(nrow(.xx$Y)),]))
})
names(effect_size1nonexo_SP) <- enough_samples

# ggplot(cbind.data.frame(effect_size=as.numeric(effect_size1nonexo_SP),
#                         num_samples=as.numeric(num_samples[match(enough_samples, names(num_samples_all_SP))]),
#                         minlogpval=-log(as.numeric(pvals_diagRE_DMDL_nonexo_SP[match(enough_samples,
#                                                                                      names(pvals_diagRE_DMDL_nonexo_SP))])),
#                         label=enough_samples),
#        aes(x=effect_size1nonexo_SP, y=minlogpval, shape=exp(-minlogpval)<0.05,
#            label=label))+
#   theme_bw()+
#   geom_point(aes(col=num_samples))+geom_label_repel(alpha=0.4)+
#   theme(legend.position = "bottom")+ggtitle('Effect size #1, nonexo')


## another effect size

num_sigs_nonexo_SP

## all sigs
effect_size3_SP <- sapply(enough_samples, function(ct){
  .xx <- all_objects_SP[[ct]]
  try(give_totalperturbation_TMBobj_sigaverage(.xx, addone=T))
})
effect_size3_SP <- as.numeric(effect_size3_SP)

names(effect_size3_SP) <- enough_samples

## nonexo
effect_size3nonexo_SP <- sapply(enough_samples, function(ct){
  .xx <- all_objects_nonexo_SP[[ct]]
  try(give_totalperturbation_TMBobj_sigaverage(.xx, addone=T))
})
effect_size3nonexo_SP <- as.numeric(effect_size3nonexo_SP)

names(effect_size3nonexo_SP) <- enough_samples
```

```{r, num_samples, echo=FALSE, results='hide', dependson=c('all_pvals')}
num_samples <- sapply(enough_samples, function(ct){
    .xx <- try(give_subset_sigs_TMBobj(load_PCAWG(ct = ct, typedata = "signaturesPCAWG"),
                                       sigs_to_remove = unique(nonexogenous$V1)))
    try(nrow(.xx$Y)/2)
})
names(num_samples) <- enough_samples

```


```{r, effectsize1_SP_2, dependson=c('load_objects_all', 'load_runs_signaturesPCAWG', 'p_vals_SP'), echo=F, fig.height=4.5, fig.width=4}

ggplot(cbind.data.frame(effect_size=as.numeric(effect_size3nonexo_SP),
                        num_samples=as.numeric(num_samples[match(enough_samples, names(num_samples_nonexo_SP))]),
                        minlogpval=-log(as.numeric(pvals_diagRE_DMDL_nonexo_SP[match(enough_samples,
                                                                                     names(pvals_diagRE_DMDL_nonexo_SP))])),
                        label=enough_samples),
       aes(x=effect_size, y=minlogpval, shape=exp(-minlogpval)<0.05,
           label=label))+
  theme_bw()+
  geom_point(aes(col=log(num_samples)))+geom_label_repel(alpha=0.4)+
  theme(legend.position = "bottom")+ggtitle('Total perturbation\nnon-exogenous signatures')+
  jcolors::scale_color_jcolors_contin("pal3", reverse = TRUE, bias = 2.25)+
    labs(x='Effect size', y='Negative log p-value')+
  guides(shape=F)


effect_size3_SP
pvals_diagRE_DMDL_SP
ggplot(cbind.data.frame(effect_size=as.numeric(effect_size3_SP),
                        num_sigs=as.numeric(num_sigs_SP[match(enough_samples, names(num_sigs_SP))]),
                        minlogpval=-log(as.numeric(pvals_diagRE_DMDL_SP[match(enough_samples,
                                                                              names(pvals_diagRE_DMDL_SP))])),
                        label=enough_samples),
       aes(x=effect_size, y=minlogpval, shape=exp(-minlogpval)<0.05,
           label=label))+
  theme_bw()+
  geom_point(aes(col=num_sigs))+geom_label_repel(alpha=0.4, size=3)+
  theme(legend.position = "bottom")+#ggtitle('Total perturbation\nnon-exogenous signatures')+
  jcolors::scale_color_jcolors_contin("pal3", reverse = TRUE)+
    labs(x='Effect size', y='Negative log p-value (all signatures)', col='Number of signatures')+
  guides(shape=F)

ggplot(cbind.data.frame(effect_size=as.numeric(effect_size3nonexo_SP),
                        num_sigs=as.numeric(num_sigs_nonexo_SP[match(enough_samples, names(num_sigs_nonexo_SP))]),
                        minlogpval=-log(as.numeric(pvals_diagRE_DMDL_nonexo_SP[match(enough_samples,
                                                                                     names(pvals_diagRE_DMDL_nonexo_SP))])),
                        label=enough_samples),
       aes(x=effect_size, y=minlogpval, shape=exp(-minlogpval)<0.05,
           label=label))+
  theme_bw()+
  geom_point(aes(col=num_sigs))+geom_label_repel(alpha=0.4, size=3)+
  theme(legend.position = "bottom")+#ggtitle('Total perturbation\nnon-exogenous signatures')+
  jcolors::scale_color_jcolors_contin("pal3", reverse = TRUE)+
    labs(x='Effect size', y='Negative log p-value (non-exogenous signatures)', col='Number of signatures')+
  guides(shape=F)
```

\section{HMP}
Simple HMP tests to see what is differentially abundant
```{r, HMP_pcawg, echo=F}
# source("../1_create_ROO/roo_functions.R")
# signature_roo[[1]]
require(HMP)


# THIS IS NOT DONE FOR SP SIGNATURES! AND WE ALSO NEED IT FOR NONEXOGENOUS SIGNATURES!
# 
# all_objects_nonexo_SP
# HMP_res_sigs <- lapply(signature_roo, function(signature_roo_it){
#   HMP::Xdc.sevsample(list(t(signature_roo_it[[1]]),
#                       t(signature_roo_it[[2]])))
# })
# 
# HMP_res_sigs_nonexo <- lapply(signature_roo, function(signature_roo_it){
#   signature_roo_it <- give_subset_sigs_TMBobj(signature_roo_it, sigs_to_remove = nonexogenous$V1)
#   HMP::Xdc.sevsample(list(t(signature_roo_it[[1]]),
#                       t(signature_roo_it[[2]])))
# })
# 
# 
# HMP_res_sigs_pval <- sapply(HMP_res_sigs, `[`, 'p value')
# names(HMP_res_sigs) <- names(signature_roo)
# names(HMP_res_sigs_pval)
# names(pvals_diagRE_DMDL_SP)
# HMP_res_sigs_pval_adj <- p.adjust(HMP_res_sigs_pval[names(HMP_res_sigs_pval) %in% paste0(names(pvals_diagRE_DMDL_SP), '.p value')], method='fdr')
# HMP_res_sigs_pval_adj
# 
# HMP_res_sigs_nonexo_pval <-  sapply(HMP_res_sigs_nonexo, `[`, 'p value')
# HMP_res_sigs_nonexo_pval_adj <-  p.adjust(HMP_res_sigs_nonexo_pval[names(HMP_res_sigs_nonexo_pval) %in% paste0(names(pvals_diagRE_DMDL_SP), '.p value')], method='fdr')
# HMP_res_sigs_nonexo_pval_adj
# test_HMP_ROOSigs(signature_roo[[1]],  slot='count_matrices_active')
```


```{r, comparison_pvals, dependson=c('HMP_pcawg', 'p_vals_SP')}
pvals_diagRE_DMDL_SP_adj <- p.adjust(pvals_diagRE_DMDL_SP, 'fdr')
pvals_diagRE_DMDL_nonexo_SP_adj <- p.adjust(pvals_diagRE_DMDL_nonexo_SP, 'fdr')
pvals_fullREDMnoscaling_SP_nonexo_subsets_and_amalgamations_adj <- p.adjust(pvals_fullREDMnoscaling_SP_nonexo_subsets_and_amalgamations, 'fdr')
pvals_fullRE_M_nonexo_SP_adj <- p.adjust(pvals_fullRE_M_nonexo_SP, 'fdr')
pvals_fullRE_DMSL_nonexo_SP_adj <- p.adjust(pvals_fullRE_DMSL_nonexo_SP, 'fdr')
names(pvals_diagRE_DMDL_SP_adj) <- names(pvals_diagRE_DMDL_nonexo_SP_adj) <- names(pvals_fullRE_M_nonexo_SP_adj) <- names(pvals_fullRE_DMSL_nonexo_SP_adj) <- names(pvals_diagRE_DMDL_SP)

table(diagRE_DMDL_DA=pvals_diagRE_DMDL_nonexo_SP_adj <= 0.05,
      fullRE_DMSL_DA=pvals_fullRE_DMSL_nonexo_SP_adj <= 0.05)


names(pvals_diagRE_DMDL_nonexo_SP_adj)[which((pvals_diagRE_DMDL_nonexo_SP_adj <= 0.05) & (fullRE_DMSL_DA=pvals_fullRE_DMSL_nonexo_SP_adj > 0.05))]
names(pvals_diagRE_DMDL_nonexo_SP_adj)[which((pvals_diagRE_DMDL_nonexo_SP_adj > 0.05) & (fullRE_DMSL_DA=pvals_fullRE_DMSL_nonexo_SP_adj <= 0.05))]

table(diagRE_DMDL_DA=pvals_diagRE_DMDL_nonexo_SP_adj <= 0.05,
      fullRE_M_DA=pvals_fullRE_M_nonexo_SP_adj <= 0.05)

# table(diagRE_DMDL_DA=pvals_diagRE_DMDL_nonexo_SP_adj <= 0.05,
#       HMP_DA=HMP_res_sigs_pval_adj <= 0.05)


# table(diagRE_DMDL_DA=pvals_diagRE_DMDL_nonexo_SP_adj < 0.05, HMP_res_sigs_DA=HMP_res_sigs < 0.05)


```

```{r, pvals_pcawg_SP, dependson=c('p_vals_SP', 'comparison_pvals'), dev='tikz', fig.height=4.5, fig.width=5.5}
p.adjust(pvals_diagRE_DMDL_SP, method = "BH")
p.adjust(pvals_diagRE_DMDL_nonexo_SP, method = "BH")

pcawg_palette <- pcawg.colour.palette(gsub("\\..*", "", enough_samples), scheme = "tumour.subtype")
names(pcawg_palette) <- enough_samples

df_pvals_DMDL_SP <- cbind.data.frame(pvals_DM=pvals_diagRE_DMDL_SP_adj,
                                     pvals_DMnonexo=pvals_diagRE_DMDL_nonexo_SP_adj,
                        num_samples=as.numeric(num_samples_all_SP),
                        num_sigs_nonexo=as.numeric(num_sigs_nonexo_SP),
                        ct=enough_samples,
                        pvals_DM_censored=sapply(-log(pvals_diagRE_DMDL_SP_adj),
                                                 function(i) min(i, 25)),
                        pvals_DMnonexo_censored=sapply(-log(pvals_diagRE_DMDL_nonexo_SP_adj),
                                                       function(i) min(i, 25)),
                        bool_censored=((-log(pvals_diagRE_DMDL_nonexo_SP_adj) > 25 )| (-log(pvals_diagRE_DMDL_SP_adj) > 25)))
ggplot(df_pvals_DMDL_SP,
       aes(x=pvals_DM_censored, y=pvals_DMnonexo_censored,
           # size=num_samples,
           label=ct, size=bool_censored))+geom_point(aes (col=ct))+
  geom_hline(yintercept = -log(0.05), lty='dashed')+geom_vline(xintercept = -log(0.05), lty='dashed')+
  geom_label_repel(size=3.2, alpha=0.6, max.overlaps = 30)+  theme_bw()+
  theme(legend.position = "bottom", legend.text=element_text(size=8))+
  labs(x='- Log p-value all signatures', y='- Log p-value nonexogenous signatures')+
  guides(size=FALSE, col=FALSE)+ #, col=guide_legend(ncol=4), 
  scale_color_manual(values = pcawg_palette)+theme(legend.position = "bottom")+
  lims(x=c(0, 30), y=c(0,30))

```


```{r, pvals_pcawg_SP_2, dependson=c('p_vals_SP', 'pvals_pcawg_SP')}

t.test(df_pvals_DMDL_SP[df_pvals_DMDL_SP$pvals_DMnonexo <= 0.05,'num_samples'],
       df_pvals_DMDL_SP[df_pvals_DMDL_SP$pvals_DMnonexo > 0.05,'num_samples'])

t.test(df_pvals_DMDL_SP[df_pvals_DMDL_SP$pvals_DMnonexo <= 0.05,'num_sigs_nonexo'],
       df_pvals_DMDL_SP[df_pvals_DMDL_SP$pvals_DMnonexo > 0.05,'num_sigs_nonexo'])

mean(df_pvals_DMDL_SP[df_pvals_DMDL_SP$pvals_DMnonexo <= 0.05,'num_sigs_nonexo'])
mean(df_pvals_DMDL_SP[df_pvals_DMDL_SP$pvals_DMnonexo > 0.05,'num_sigs_nonexo'])

```

Does DA or not scale with the avergae number of mutations in the observed exposures (i.e. per patient and group) of the relevant ct?
```{r, num_muts_samples, dependson=c('pvals_pcawg_SP')}

average_num_muts_SP <- sapply(enough_samples, function(ct){
    .xx <- all_objects_SP[[ct]]
    try(mean(rowSums(.xx$Y)))
})

average_num_muts_SP

plot(log2(df_pvals_DMDL_SP$pvals_DM), log2(average_num_muts_SP))

t.test(log2(average_num_muts_SP)[df_pvals_DMDL_SP$pvals_DMnonexo <= 0.05],
       log2(average_num_muts_SP)[df_pvals_DMDL_SP$pvals_DMnonexo > 0.05])

```



```{r, pvals_pcawg_SP_nonscaling_comparison, dependson=c('p_vals_SP', 'comparison_pvals'), dev='tikz', fig.height=4.5, fig.width=5.5}

pcawg_palette <- pcawg.colour.palette(gsub("\\..*", "", enough_samples), scheme = "tumour.subtype")
names(pcawg_palette) <- enough_samples

pvals_diagRE_DMDL_nonexo_SP_adj
pvals_fullREDMnoscaling_SP_nonexo_subsets_and_amalgamations_adj

df_pvals_fullREDMnoscaling_SP_nonexo_subsets_and_amalgamations <- cbind.data.frame(pvals_DMnonexo_nonscaling=pvals_fullREDMnoscaling_SP_nonexo_subsets_and_amalgamations_adj,
                                     pvals_DMnonexo=pvals_diagRE_DMDL_nonexo_SP_adj,
                        num_samples=as.numeric(num_samples_all_SP),
                        num_sigs_nonexo=as.numeric(num_sigs_nonexo_SP),
                        ct=enough_samples,
                        pvals_DM_nonscaling_censored=sapply(-log(pvals_fullREDMnoscaling_SP_nonexo_subsets_and_amalgamations_adj),
                                                 function(i) min(i, 25)),
                        pvals_DMnonexo_censored=sapply(-log(pvals_diagRE_DMDL_nonexo_SP_adj),
                                                       function(i) min(i, 25)),
                        bool_censored=((-log(pvals_diagRE_DMDL_nonexo_SP_adj) > 25 )| (-log(pvals_fullREDMnoscaling_SP_nonexo_subsets_and_amalgamations_adj) > 25)))
ggplot(df_pvals_fullREDMnoscaling_SP_nonexo_subsets_and_amalgamations,
       aes(x=pvals_DM_nonscaling_censored, y=pvals_DMnonexo_censored,
           # size=num_samples,
           label=ct, size=bool_censored))+geom_point(aes (col=ct))+
  geom_hline(yintercept = -log(0.05), lty='dashed')+geom_vline(xintercept = -log(0.05), lty='dashed')+
  geom_label_repel(size=3.2, alpha=0.6, max.overlaps = 30)+  theme_bw()+
  theme(legend.position = "bottom", legend.text=element_text(size=8))+
  labs(x='- Log p-value all signatures', y='- Log p-value nonexogenous signatures')+
  guides(size=FALSE, col=FALSE)+ #, col=guide_legend(ncol=4), 
  scale_color_manual(values = pcawg_palette)+theme(legend.position = "bottom")+
  lims(x=c(0, 30), y=c(0,30))

```

See script `PCAWG_HMP_and_alternative_methods.R` for the analyses of PCAWG data using alternative models.

\section{Tracksig}

```{r, tracksig_comparison, fig.height=6, fig.width=6, dev='tikz'}

tracksig = read.csv("../../data/restricted/tracksig/changepoints_stats_tracksig.csv", stringsAsFactors = FALSE)
tracksig = tracksig %>% group_by(type) %>%
  dplyr::summarize(count = n(),bool_changepoints=sum(n_changepoints > 0)) %>%
  mutate(tracksig_frac= bool_changepoints/count)
tracksig = cbind.data.frame(pvals_diagRE_DMDL_SP_adj,
                 tracksig[match(names(pvals_diagRE_DMDL_SP_adj), tracksig$type),],
                 effect_size3_SP=effect_size3_SP[match(names(pvals_diagRE_DMDL_SP_adj), names(effect_size3_SP))])
tracksig$ct = rownames(tracksig)
tracksig$minpvals = -log2(tracksig$pvals_diagRE_DM)


pcawg_palette <- pcawg.colour.palette(gsub("\\..*", "", tracksig$ct), scheme = "tumour.subtype")
names(pcawg_palette) <- tracksig$ct

ggplot(tracksig, aes(x=-log2(pvals_diagRE_DMDL_SP_adj), y=tracksig_frac, label=ct, size=count))+geom_point(aes(col=ct))+geom_label_repel(size=3, col='black')+
  labs(x='-log2 p-value of diagRE DMDL', y='Fraction of TrackSig samples with some changepoint')+
    scale_color_manual(values = pcawg_palette)+theme(legend.position = "bottom")+
  # scale_x_continuous(trans = "log2")+
  theme_bw()+theme(legend.position = "bottom")

ggplot(tracksig, aes(x=-log2(pvals_diagRE_DMDL_nonexo_SP_adj), y=tracksig_frac, label=ct, size=count))+geom_point(aes(col=ct))+geom_label_repel(size=3, col='black')+
  labs(x='-log2 p-value of diagRE DMDL (nonexo)', y='Fraction of TrackSig samples with some changepoint')+
    scale_color_manual(values = pcawg_palette)+theme(legend.position = "bottom")+
  theme_bw()+theme(legend.position = "bottom")


ggplot(tracksig, aes(x=effect_size3_SP, y=tracksig_frac, label=ct, col=ct))+
  geom_point(aes(size=minpvals))+geom_label_repel(max.overlaps = 5)+
  labs(x='Effect size', y='Fraction of TrackSig samples with some changepoint', col="")+theme_bw()+
  scale_color_manual(values = pcawg_palette)+theme(legend.position = "bottom")+
  guides(col=guide_legend(ncol=4), size=FALSE)

```

Same plots, but smaller, for images
```{r, tracksig_comparison_images, fig.height=3, fig.width=3, dev='tikz', dependson=c('tracksig_comparison')}

ggplot(tracksig, aes(x=-log2(pvals_diagRE_DMDL_SP_adj), y=tracksig_frac, label=ct, size=count))+geom_point(aes(col=ct))+geom_label_repel(, max.overlaps = 4, size=3, col='black')+
  labs(x='-log2 p-value of\n diagRE DMDL', y='Fraction of TrackSig samples\n with some changepoint')+
    scale_color_manual(values = pcawg_palette)+theme(legend.position = "bottom")+
  # scale_x_continuous(trans = "log2")+
  theme_bw()+theme(legend.position = "bottom")+guides(col=FALSE)+labs(size='N. obs')

ggplot(tracksig, aes(x=-log2(pvals_diagRE_DMDL_nonexo_SP_adj), y=tracksig_frac, label=ct, size=count))+geom_point(aes(col=ct))+
  geom_label_repel(size=3, col='black', max.overlaps = 4)+
  labs(x='-log2 p-value of\n diagRE DMDL (nonexo)', y='Fraction of TrackSig samples\n with some changepoint')+
    scale_color_manual(values = pcawg_palette)+theme(legend.position = "bottom")+
  theme_bw()+theme(legend.position = "bottom")+guides(col=FALSE)+labs(size='N. obs')

```

```{r, legend_ct, dev='tikz', fig.width=9, fig.height=3}
plot_for_ct_legend <- ggplot(tracksig, aes(x=-log2(pvals_diagRE_DMDL_nonexo_SP_adj), y=tracksig_frac, label=ct, size=count))+geom_point(aes(col=ct))+
  geom_label_repel(size=3, col='black', max.overlaps = 2)+
  labs(x='-log2 p-value of\n diagRE DMDL (nonexo)', y='Fraction of TrackSig samples\n with some changepoint')+
    scale_color_manual(values = pcawg_palette)+theme(legend.position = "bottom")+
  theme_bw()+theme(legend.position = "bottom")+labs(size='N. observations')+
  guides(size=FALSE)+labs(col='')

legend_ct <- (cowplot::get_legend(plot_for_ct_legend))
# pdf("../../results/results_TMB/pcawg/legend_cts.pdf", height = 1, width = 6.5)
grid.newpage()
grid.draw(legend_ct)
# dev.off()
```

```{r, gerstung, dev='tikz'}

gerstung_changing_sigs_early_late <- readxl::read_excel("/Users/morril01/Documents/PhD/GlobalDA/data/restricted/pcawg/41586_2019_1907_MOESM7_ESM.xlsx", sheet = "Figure4c")
gerstung_changing_sigs_clonal_subclonal <- readxl::read_excel("/Users/morril01/Documents/PhD/GlobalDA/data/restricted/pcawg/41586_2019_1907_MOESM7_ESM.xlsx", sheet = "Figure4d")

# gerstung_changing_sigs <- readxl::read_excel("/Users/morril01/Documents/PhD/GlobalDA/data/restricted/pcawg/41586_2019_1907_MOESM9_ESM.xlsx", sheet = "signatures-changing")
# gerstung_changing_sigs <- readxl::read_excel("/Users/morril01/Documents/PhD/GlobalDA/data/restricted/pcawg/41586_2019_1907_MOESM9_ESM.xlsx", sheet = "signatures-changing")
# gerstung_constant_sigs <- readxl::read_excel("/Users/morril01/Documents/PhD/GlobalDA/data/restricted/pcawg/41586_2019_1907_MOESM9_ESM.xlsx", sheet = "signatures-constant")
# gerstung_changing_sigs
# gerstung_constant_sigs

gerstung_changing_sigs_earlylate <- gerstung_changing_sigs_early_late #gerstung_changing_sigs[gerstung_changing_sigs$time == "early-late",]
gerstung_changing_sigs_clonalsubclonal <- gerstung_changing_sigs_clonal_subclonal #gerstung_changing_sigs[gerstung_changing_sigs$time == "clonal-subclonal",]

gerstung_changing_sigs_earlylate$signature[(gerstung_changing_sigs_earlylate$signature == "SBS6.14.15.20.21.26.44")] = "SBS6+"
gerstung_changing_sigs_clonalsubclonal$signature[(gerstung_changing_sigs_clonalsubclonal$signature == "SBS6.14.15.20.21.26.44")] = "SBS6+"
gerstung_changing_sigs_earlylate$signature <- gsub("_", ".", gerstung_changing_sigs_earlylate$signature)
gerstung_changing_sigs_clonalsubclonal$signature <- gsub("_", ".", gerstung_changing_sigs_clonalsubclonal$signature)

# df_changes_el <- gerstung_changing_sigs_earlylate %>% group_by(signature) %>% dplyr::summarise(median(mean_change))
# df_changes_cs <- gerstung_changing_sigs_clonalsubclonal %>% group_by(signature) %>% dplyr::summarise(median(mean_change))
df_changes_el <- gerstung_changing_sigs_earlylate %>% group_by(signature) %>% dplyr::summarise(median(log2fc_earlyLate))
df_changes_cs <- gerstung_changing_sigs_clonalsubclonal %>% group_by(signature) %>% dplyr::summarise(median(log2fc_clonalSubclonal))


# grid.arrange(ggplot(gerstung_changing_sigs_earlylate, aes(x=factor(signature, levels=df_changes_el$signature[order(df_changes_el$`median(mean_change)`)]),
#                                    y=mean_change, group=signature,col=histology_abbreviation))+geom_boxplot()+geom_jitter()+
#                geom_hline(yintercept = 0, lty='dashed')+
#                guides(col=FALSE)+theme_bw()+
#     theme(axis.text.x=element_text(angle = 45, hjust = 1, vjust=1))+ggtitle('Early vs late'),
# ggplot(gerstung_changing_sigs_clonalsubclonal, aes(x=factor(signature, levels=df_changes_cs$signature[order(df_changes_cs$`median(mean_change)`)]),
#                                              y=mean_change, group=signature,col=histology_abbreviation))+geom_hline(yintercept = 0, lty='dashed')+
#   geom_boxplot()+  geom_jitter()+guides(col=FALSE)+theme_bw()+
#   theme(axis.text.x=element_text(angle = 45, hjust = 1, vjust=1))+ggtitle('Clonal vs subclonal'),
# nrow=2)

## removing cancer types where there aren't many observations
select_self <- function(i) i[i]
gerstung_changing_sigs_earlylate <- gerstung_changing_sigs_earlylate %>% dplyr::filter(signature %in% names(select_self(table(gerstung_changing_sigs_earlylate$signature) > 5)))
gerstung_changing_sigs_clonalsubclonal <- gerstung_changing_sigs_clonalsubclonal %>% dplyr::filter(signature %in% names(select_self(table(gerstung_changing_sigs_clonalsubclonal$signature) > 5)))

pcawg_palette <- pcawg.colour.palette(x = gsub("-", ".", tolower(gsub("\\..*", "", sort(unique(gerstung_changing_sigs_earlylate$tumour_type))))),
                                      scheme = "tumour.subtype")
names(pcawg_palette) <- sort(unique(gerstung_changing_sigs_earlylate$tumour_type))


unique(gerstung_changing_sigs_clonal_subclonal$signature)
gerstung_changing_sigs_earlylate$signature <-  factor(gerstung_changing_sigs_earlylate$signature,
                                                    levels=df_changes_el$signature[order(df_changes_el$`median(log2fc_earlyLate)`)])
gerstung_changing_sigs_clonalsubclonal$signature <- factor(gerstung_changing_sigs_clonalsubclonal$signature,
                                                           levels=df_changes_cs$signature[order(df_changes_cs$`median(log2fc_clonalSubclonal)`)])

# grid.arrange(ggplot(gerstung_changing_sigs_earlylate, aes(x=signature,
#                                                           y=log2fc_earlyLate, group=signature,col=tumour_type))+geom_boxplot()+geom_jitter(alpha=0.2)+
#                geom_hline(yintercept = 0, lty='dashed')+
#                guides(col=FALSE)+theme_bw()+
#                theme(axis.text.x=element_text(angle = 45, hjust = 1, vjust=1))+ggtitle('Early vs late')+
#                scale_color_manual(values = pcawg_palette)+labs(x='', y='Log 2 fold-change between early and late clonal mutations'),
#              ggplot(gerstung_changing_sigs_clonalsubclonal, aes(x=signature,
#                                                                 y=log2fc_clonalSubclonal, group=signature,col=tumour_type))+
#                geom_hline(yintercept = 0, lty='dashed')+
#                geom_boxplot()+  geom_jitter(alpha=0.2)+guides(col=FALSE)+theme_bw()+
#                theme(axis.text.x=element_text(angle = 45, hjust = 1, vjust=1))+ggtitle('Clonal vs subclonal')+
#                scale_color_manual(values = pcawg_palette)+labs(x='', y='Log 2 fold-change between clonal and subclonal mutation'),
#              nrow=2)
ggplot(gerstung_changing_sigs_earlylate, aes(x=signature,
                                                          y=log2fc_earlyLate, group=signature,col=tumour_type))+geom_boxplot()+geom_jitter(alpha=0.2)+
               geom_hline(yintercept = 0, lty='dashed')+
               guides(col=FALSE)+theme_bw()+
               theme(axis.text.x=element_text(angle = 45, hjust = 1, vjust=1))+ggtitle('Early vs late')+
               scale_color_manual(values = pcawg_palette)+labs(x='', y='Log 2 fold-change between early and late clonal mutations')

ggplot(gerstung_changing_sigs_clonalsubclonal, aes(x=signature,
                                                                y=log2fc_clonalSubclonal, group=signature,col=tumour_type))+
               geom_hline(yintercept = 0, lty='dashed')+
               geom_boxplot()+  geom_jitter(alpha=0.2)+guides(col=FALSE)+theme_bw()+
               theme(axis.text.x=element_text(angle = 45, hjust = 1, vjust=1))+ggtitle('Clonal vs subclonal')+
               scale_color_manual(values = pcawg_palette)+labs(x='', y='Log 2 fold-change between clonal and subclonal mutation')

```

```{r, gerstung2, dev='tikz', dependson=c('gerstung'), fig.height=3, fig.width=4.5}
ggplot(gerstung_changing_sigs_earlylate[grepl('SBS', gerstung_changing_sigs_earlylate$signature),], aes(x=signature,
                                                          y=log2fc_earlyLate, group=signature,col=tumour_type))+geom_boxplot()+geom_jitter(alpha=0.2)+
               geom_hline(yintercept = 0, lty='dashed')+
               guides(col=FALSE)+theme_bw()+
               theme(axis.text.x=element_text(angle = 45, hjust = 1, vjust=1))+ggtitle('Early vs late')+
               scale_color_manual(values = pcawg_palette)+labs(x='', y='Log 2 fold-change between \nearly and late clonal mutations')

ggplot(gerstung_changing_sigs_clonalsubclonal[grepl('SBS', gerstung_changing_sigs_clonalsubclonal$signature),], aes(x=signature,
                                                                y=log2fc_clonalSubclonal, group=signature,col=tumour_type))+
               geom_hline(yintercept = 0, lty='dashed')+
               geom_boxplot()+  geom_jitter(alpha=0.2)+guides(col=FALSE)+theme_bw()+
               theme(axis.text.x=element_text(angle = 45, hjust = 1, vjust=1))+ggtitle('Clonal vs subclonal')+
               scale_color_manual(values = pcawg_palette)+labs(x='', y='Log 2 fold-change between \nclonal and subclonal mutation')

```

```{r, gerstung3, dev='tikz', dependson=c('gerstung'), fig.height=3, fig.width=4.5}

df_changes_el_persample <- gerstung_changing_sigs_earlylate %>% group_by(samplename) %>% dplyr::summarise(median(log2fc_earlyLate))
df_changes_cs_persample <- gerstung_changing_sigs_clonalsubclonal %>% group_by(samplename) %>% dplyr::summarise(median(log2fc_clonalSubclonal))
gerstung_changing_sigs_earlylate$samplename <-  factor(gerstung_changing_sigs_earlylate$samplename,
                                                             levels=df_changes_el_persample$samplename[order(df_changes_el_persample$`median(log2fc_earlyLate)`)])
gerstung_changing_sigs_clonalsubclonal$samplename <-  factor(gerstung_changing_sigs_clonalsubclonal$samplename,
                                                             levels=df_changes_cs_persample$samplename[order(df_changes_cs_persample$`median(log2fc_clonalSubclonal)`)])
table(is.na(gerstung_changing_sigs_earlylate$samplename))
table(is.na(gerstung_changing_sigs_clonalsubclonal$samplename))

ggplot(gerstung_changing_sigs_earlylate, aes(x=samplename,
                                             y=log2fc_earlyLate, group=samplename,col=tumour_type))+geom_boxplot()+geom_jitter(alpha=0.05)+
  geom_hline(yintercept = 0, lty='dashed')+
  guides(col=FALSE)+theme_bw()+
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())+
  scale_color_manual(values = pcawg_palette)+labs(x='', y='Log 2 fold-change between\nearly and late clonal mutations')+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())


ggplot(gerstung_changing_sigs_clonalsubclonal, aes(x=samplename,
                                                   y=log2fc_clonalSubclonal, group=samplename,col=tumour_type))+
  geom_hline(yintercept = 0, lty='dashed')+
  geom_boxplot()+  geom_jitter(alpha=0.05)+guides(col=FALSE)+theme_bw()+
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())+ggtitle('Clonal vs subclonal')+
  scale_color_manual(values = pcawg_palette)+labs(x='', y='Log 2 fold-change between\nclonal and subclonal mutation')+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())


ggplot(gerstung_changing_sigs_clonalsubclonal, aes(x=tumour_type,
                                                   y=log2fc_clonalSubclonal, group=tumour_type,col=tumour_type))+
  geom_hline(yintercept = 0, lty='dashed')+
  geom_boxplot()+  geom_jitter(alpha=0.2)+guides(col=FALSE)+theme_bw()+
  theme(axis.text.x=element_text(angle = 45, hjust = 1, vjust=1))+ggtitle('Early vs late')+
  ggtitle('Clonal vs subclonal')+
  scale_color_manual(values = pcawg_palette)+labs(x='', y='Log 2 fold-change between clonal and subclonal mutation')

```

```{r, gerstung4, dev='tikz', dependson=c('gerstung'), fig.height=3, fig.width=4.5}

gerstung_changing_sigs_clonalsubclonal_var <- gerstung_changing_sigs_clonalsubclonal %>%
  dplyr::group_by(tumour_type) %>% summarise(varlog2=var(log2fc_clonalSubclonal), count=n())
ggplot(gerstung_changing_sigs_clonalsubclonal_var,
       aes(x=varlog2, y=count, label=tumour_type, col=tumour_type))+geom_point()+
  scale_color_manual(values = pcawg_palette)+guides(col=FALSE)+theme_bw()+geom_label_repel(max.overlaps = 5)
  labs(x='Variance of log2 fold change in cancer type', y='Number of observations')
```

```{r, gerstung5, dev='tikz', dependson=c('gerstung'), fig.height=3, fig.width=4.5}

perturbed_betas_diagRE_DMDL_nonexo_SP_df_summary <- perturbed_betas_diagRE_DMDL_nonexo_SP_df %>% dplyr::group_by(sig) %>%
  summarise(meanperturbed=mean( !(perturbed == 'FALSE')))

perturbed_betas_diagRE_DMDL_nonexo_SP_df_summary
comparison_with_gerstung_earlylate <- cbind.data.frame(perturbed_betas_diagRE_DMDL_nonexo_SP_df_summary,
                                                            df_changes_el[match(perturbed_betas_diagRE_DMDL_nonexo_SP_df_summary$sig,
                                                                                df_changes_el$signature),])
comparison_with_gerstung_earlylate
comparison_with_gerstung_earlylate$medianlog2fcearlylate = comparison_with_gerstung_earlylate$`median(log2fc_earlyLate)`
ggplot(comparison_with_gerstung_earlylate, aes(x=medianlog2fcearlylate, y=meanperturbed, label=signature))+geom_point()+geom_label_repel()+theme_bw()+
  labs(x='Median of log2-fold change of\nsignatures in cancer type', y='Fraction of cancer types with\nsignature perturbed (minimal p.)')

```

Barplots of cancer types with and without differential abundance
<!-- give_barplot_from_obj(obj = obj_Bone_Osteosarc, legend_on = TRUE, verbose=F) -->

```{r, barplots_SP_thesis, fig.height=3, dev='tikz'}
give_barplot_from_obj(obj = signatures_PCAWG[['CNS-Medullo']], legend_on = F,
                        nrow=1, verbose=F,
                        only_normalised=T)
give_barplot_from_obj(obj = signatures_PCAWG[['Uterus-AdenoCA']], legend_on = F,
                        nrow=1, verbose=F,
                        only_normalised=T)
give_barplot_from_obj(obj = signatures_PCAWG[['Ovary-AdenoCA']], legend_on = F,
                        nrow=1, verbose=F,
                        only_normalised=T)
```

\section{Correlations of cancer types and of signatures based on betas}
```{r, correlations_from_beta_slopes, dependson=c('load_runs_signaturesPCAWG', 'names_logR_SP'), fig.height=6.5, echo=F}
aaa <- list()
for(ct in names(diagRE_DMDL_nonexo_SP)){
  .betas_ct_it <- data.frame(plot_betas(TMB_obj = diagRE_DMDL_nonexo_SP[[ct]],
                                        names_cats= logR_nonexo_notsorted_SP[[ct]],
                                        return_df=T, plot=F))
  .slopes_minpert <- .betas_ct_it %>% dplyr::filter(type_beta == "Slope") %>% dplyr::select(Estimate) %>% unlist()
  aaa[[ct]] <- plot_betas(TMB_obj = diagRE_DMDL_nonexo_SP[[ct]], names_cats= logR_nonexo_notsorted_SP[[ct]],
                    return_df=T, plot=F, only_slope = T, line_zero=F, add_confint = T)
}

aaa <- lapply(aaa, function(i) cbind(i, numerator_LogR = gsub("/.*", "", i$LogR)))
aaa <- lapply(names(aaa), function(i) cbind(aaa[[i]], ct=i))
aaa <- do.call('rbind', aaa)

## now put NA whenever we don't have a 

aaa_dcast <- dcast(aaa, formula = numerator_LogR~ct, value.var = 'Estimate')
rownames(aaa_dcast) <- aaa_dcast$numerator_LogR
aaa_dcast <- aaa_dcast[,-1]

cors <- outer(1:ncol(aaa_dcast), 1:ncol(aaa_dcast), Vectorize(function(i,j){
  try(cor(x = unlist(aaa_dcast[,i]), y = unlist(aaa_dcast[,j]), use = "pairwise.complete.obs"))}))
cors <- apply(cors, 2, as.numeric)

cors[is.na(cors)] = 0

rownames(cors) <- colnames(cors) <- colnames(aaa_dcast)
print(pheatmap::pheatmap(cors, color = viridis::cividis(10)))
dev.off()

pdf("../../results/results_TMB/pcawg/correlation_cancertypes_from_betaslopes.pdf")
print(pheatmap::pheatmap(cors, color = viridis::cividis(10)))
dev.off()


```

```{r, correlations_from_beta_slopes_2, dependson=c('load_runs_signaturesPCAWG', 'names_logR_SP', 'correlations_from_beta_slopes'), fig.height=6, echo=F}
cors_sigs <- outer(1:nrow(aaa_dcast), 1:nrow(aaa_dcast), Vectorize(function(i,j){
    try(cor(x = unlist(aaa_dcast[i,]), y = unlist(aaa_dcast[j,]), use = "pairwise.complete.obs"))}))
cors_sigs <- apply(cors_sigs, 2, as.numeric)

cors_sigs[is.na(cors_sigs)] = 0

rownames(cors_sigs) <- colnames(cors_sigs) <- paste0('SBS', rownames(aaa_dcast))

print(pheatmap::pheatmap(cors_sigs))

dev.off()

pdf("../../results/results_TMB/pcawg/correlation_signatures_from_betaslopes.pdf")
print(pheatmap::pheatmap(cors_sigs, color = viridis::cividis(10)))
dev.off()
```